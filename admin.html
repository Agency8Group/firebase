<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>0000셀러 주문 관리자 페이지</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            margin: 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        
        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .controls {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #1e7e34;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }
        
        .orders-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .section-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background-color: #f8f9fa;
        }
        
        .section-header h2 {
            margin: 0;
            color: #333;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .filter-select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .orders-table th {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .orders-table td {
            border: 1px solid #dee2e6;
            padding: 8px;
            vertical-align: top;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-접수 {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-조리중 {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-배송중 {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-완료 {
            background-color: #c3e6cb;
            color: #155724;
        }
        
        .status-취소 {
            background-color: #f5c6cb;
            color: #721c24;
        }
        
        .status-select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .sidebar {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stats-card h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .stats-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stats-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .recent-orders {
            margin-top: 20px;
        }
        
        .recent-orders h3 {
            margin: 0 0 15px 0;
            color: #333;
        }
        
        .recent-order-item {
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }
        
        .recent-order-item h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: #333;
        }
        
        .recent-order-item p {
            margin: 0;
            font-size: 12px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🔧 0000셀러 주문 관리자</h1>
        <div class="status-bar">
            <div id="status" class="status disconnected">
                🔴 Firebase 연결 중...
            </div>
            <div class="controls">
                <button class="btn btn-success" onclick="exportToExcel()">📥 Excel 내보내기</button>
                <button class="btn btn-primary" onclick="refreshOrders()">🔄 새로고침</button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="orders-section">
            <div class="section-header">
                <h2>📋 주문 목록</h2>
                <div class="filters">
                    <select id="statusFilter" class="filter-select" onchange="filterOrders()">
                        <option value="">전체 상태</option>
                        <option value="접수">접수</option>
                        <option value="조리중">조리중</option>
                        <option value="배송중">배송중</option>
                        <option value="완료">완료</option>
                        <option value="취소">취소</option>
                    </select>
                    <select id="dateFilter" class="filter-select" onchange="filterOrders()">
                        <option value="">전체 기간</option>
                        <option value="today">오늘</option>
                        <option value="week">이번 주</option>
                        <option value="month">이번 달</option>
                    </select>
                </div>
            </div>
            
            <div class="table-container">
                <table class="orders-table" id="ordersTable">
                    <thead>
                        <tr>
                            <th>주문번호</th>
                            <th>고객명</th>
                            <th>연락처</th>
                            <th>상품명</th>
                            <th>수량</th>
                            <th>주소</th>
                            <th>상태</th>
                            <th>접수일시</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <!-- 주문 데이터가 여기에 동적으로 추가됩니다 -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="sidebar">
            <div class="stats-card">
                <h3>📊 오늘의 통계</h3>
                <div class="stats-number" id="todayOrders">0</div>
                <div class="stats-label">주문 건수</div>
            </div>
            
            <div class="stats-card">
                <h3>💰 매출 현황</h3>
                <div class="stats-number" id="todayRevenue">0원</div>
                <div class="stats-label">예상 매출</div>
            </div>
            
            <div class="recent-orders">
                <h3>🆕 최근 주문</h3>
                <div id="recentOrdersList">
                    <!-- 최근 주문이 여기에 표시됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, query, orderByChild } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA3og6X2bk2Tb2cvs9wiTm_HqdqdlIuTt8",
            authDomain: "main-project-5d624.firebaseapp.com",
            projectId: "main-project-5d624",
            storageBucket: "main-project-5d624.firebasestorage.app",
            messagingSenderId: "232188977313",
            appId: "1:232188977313:web:247a5557753a2ead6750e0",
            measurementId: "G-BWVCXZMY53",
            databaseURL: "https://main-project-5d624-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // DOM 요소들
        const statusDiv = document.getElementById('status');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const todayOrdersSpan = document.getElementById('todayOrders');
        const todayRevenueSpan = document.getElementById('todayRevenue');
        const recentOrdersList = document.getElementById('recentOrdersList');

        // 연결 상태 확인
        const connectedRef = ref(database, ".info/connected");
        onValue(connectedRef, (snap) => {
            if (snap.val() === true) {
                statusDiv.textContent = "🟢 Firebase 연결됨 - 실시간 주문 관리 중!";
                statusDiv.className = "status connected";
            } else {
                statusDiv.textContent = "🔴 Firebase 연결 끊김";
                statusDiv.className = "status disconnected";
            }
        });

        // 실시간 주문 데이터 리스너
        const ordersRef = ref(database, 'orders');
        const ordersQuery = query(ordersRef, orderByChild('createdAt'));
        onValue(ordersQuery, (snapshot) => {
            const data = snapshot.val();
            updateOrdersTable(data);
            updateStats(data);
            updateRecentOrders(data);
        });

        // 주문 테이블 업데이트
        function updateOrdersTable(data) {
            ordersTableBody.innerHTML = '';
            
            if (!data) {
                ordersTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">주문이 없습니다.</td></tr>';
                return;
            }

            const entries = Object.entries(data);
            const filteredEntries = filterOrdersData(entries);
            
            if (filteredEntries.length === 0) {
                ordersTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">필터링된 주문이 없습니다.</td></tr>';
                return;
            }

            // 최신 주문부터 표시
            filteredEntries.reverse().forEach(([id, order]) => {
                const row = createOrderRow(id, order);
                ordersTableBody.appendChild(row);
            });
        }

        // 주문 행 생성
        function createOrderRow(id, order) {
            const row = document.createElement('tr');
            const orderDate = new Date(order.createdAt);
            const fullAddress = [order.address, order.detailAddress].filter(Boolean).join(' ');
            
            row.innerHTML = `
                <td><strong>${order.orderNumber}</strong></td>
                <td>${order.customerName}</td>
                <td>${order.phone}</td>
                <td>${order.product}</td>
                <td>${order.quantity}개</td>
                <td style="max-width: 200px; word-break: break-all;">${fullAddress}</td>
                <td>
                    <span class="status-badge status-${order.status}">${order.status}</span>
                </td>
                <td>${orderDate.toLocaleString('ko-KR')}</td>
                <td>
                    <select class="status-select" onchange="updateOrderStatus('${id}', this.value)">
                        <option value="접수" ${order.status === '접수' ? 'selected' : ''}>접수</option>
                        <option value="조리중" ${order.status === '조리중' ? 'selected' : ''}>조리중</option>
                        <option value="배송중" ${order.status === '배송중' ? 'selected' : ''}>배송중</option>
                        <option value="완료" ${order.status === '완료' ? 'selected' : ''}>완료</option>
                        <option value="취소" ${order.status === '취소' ? 'selected' : ''}>취소</option>
                    </select>
                </td>
            `;

            return row;
        }

        // 주문 상태 업데이트
        window.updateOrderStatus = function(orderId, newStatus) {
            const orderRef = ref(database, `orders/${orderId}/status`);
            set(orderRef, newStatus);
        };

        // 통계 업데이트
        function updateStats(data) {
            if (!data) {
                todayOrdersSpan.textContent = '0';
                todayRevenueSpan.textContent = '0원';
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const entries = Object.entries(data);
            const todayOrders = entries.filter(([id, order]) => {
                const orderDate = new Date(order.createdAt);
                return orderDate >= today && orderDate < tomorrow;
            });

            todayOrdersSpan.textContent = todayOrders.length;
            
            // 예상 매출 계산 (상품당 10,000원 가정)
            const totalRevenue = todayOrders.reduce((sum, [id, order]) => {
                return sum + (order.quantity * 10000);
            }, 0);
            
            todayRevenueSpan.textContent = totalRevenue.toLocaleString() + '원';
        }

        // 최근 주문 업데이트
        function updateRecentOrders(data) {
            if (!data) {
                recentOrdersList.innerHTML = '<p style="color: #666; font-size: 12px;">최근 주문이 없습니다.</p>';
                return;
            }

            const entries = Object.entries(data);
            const recentOrders = entries.slice(-5).reverse(); // 최근 5개

            recentOrdersList.innerHTML = '';
            recentOrders.forEach(([id, order]) => {
                const orderDate = new Date(order.createdAt);
                const item = document.createElement('div');
                item.className = 'recent-order-item';
                item.innerHTML = `
                    <h4>${order.customerName} - ${order.product}</h4>
                    <p>${orderDate.toLocaleString('ko-KR')} | ${order.status}</p>
                `;
                recentOrdersList.appendChild(item);
            });
        }

        // 주문 필터링
        function filterOrdersData(entries) {
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            return entries.filter(([id, order]) => {
                // 상태 필터
                if (statusFilter && order.status !== statusFilter) {
                    return false;
                }

                // 날짜 필터
                if (dateFilter) {
                    const orderDate = new Date(order.createdAt);
                    const now = new Date();
                    
                    switch (dateFilter) {
                        case 'today':
                            const today = new Date(now);
                            today.setHours(0, 0, 0, 0);
                            const tomorrow = new Date(today);
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            return orderDate >= today && orderDate < tomorrow;
                        
                        case 'week':
                            const weekAgo = new Date(now);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            return orderDate >= weekAgo;
                        
                        case 'month':
                            const monthAgo = new Date(now);
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            return orderDate >= monthAgo;
                    }
                }

                return true;
            });
        }

        // 필터 적용
        window.filterOrders = function() {
            const ordersRef = ref(database, 'orders');
            const ordersQuery = query(ordersRef, orderByChild('createdAt'));
            onValue(ordersQuery, (snapshot) => {
                const data = snapshot.val();
                updateOrdersTable(data);
            });
        };

        // 새로고침
        window.refreshOrders = function() {
            const ordersRef = ref(database, 'orders');
            const ordersQuery = query(ordersRef, orderByChild('createdAt'));
            onValue(ordersQuery, (snapshot) => {
                const data = snapshot.val();
                updateOrdersTable(data);
                updateStats(data);
                updateRecentOrders(data);
            });
        };

        // Excel 내보내기
        window.exportToExcel = function() {
            const ordersRef = ref(database, 'orders');
            onValue(ordersRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    alert('내보낼 주문 데이터가 없습니다.');
                    return;
                }

                const entries = Object.entries(data);
                const excelData = entries.map(([id, order]) => ({
                    '주문번호': order.orderNumber,
                    '고객명': order.customerName,
                    '연락처': order.phone,
                    '상품명': order.product,
                    '수량': order.quantity,
                    '주소': [order.address, order.detailAddress].filter(Boolean).join(' '),
                    '상태': order.status,
                    '메모': order.memo || '',
                    '접수일시': new Date(order.createdAt).toLocaleString('ko-KR')
                }));

                const ws = XLSX.utils.json_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "주문목록");
                
                const fileName = `주문목록_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
            }, { onlyOnce: true });
        };
    </script>
</body>
</html>

