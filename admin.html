<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>0000셀러 주문 관리자 페이지</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <!-- Firebase Authentication SDK 추가 -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
            import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
            
            // Firebase 설정
            const firebaseConfig = {
                apiKey: "AIzaSyA4Z1B42fmBIJznBED11XIIiVVKN5OSQ1E",
                authDomain: "seller1-b8a4c.firebaseapp.com",
                projectId: "seller1-b8a4c",
                storageBucket: "seller1-b8a4c.firebasestorage.app",
                messagingSenderId: "740000823974",
                appId: "1:740000823974:web:ac62ca392ffb34e96e9267",
                measurementId: "G-Q8ZNT6PDB9",
                databaseURL: "https://seller1-b8a4c-default-rtdb.asia-southeast1.firebasedatabase.app",
            };
            
            // Firebase 초기화
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            
            // 전역 변수로 auth와 app 객체 설정
            window.auth = auth;
            window.app = app;
            
            // 인증 상태 변경 감지
            // 초기 렌더링 시 모달 깜빡임 방지: DOMContentLoaded 이후에 상태 반영
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // 로그인 성공
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    const userInfo = document.getElementById('userInfo');
                    const userInfoSpan = userInfo ? userInfo.querySelector('span') : null;
                    if (userInfoSpan) {
                        userInfoSpan.textContent = `관리자: ${user.email}`;
                    }
                    if (userInfo) userInfo.style.display = 'flex';
                    const logoutBtn = document.getElementById('logoutBtn');
                    if (logoutBtn) logoutBtn.style.display = 'inline-flex';
                } else {
                    // 로그아웃 상태
                    document.getElementById('loginModal').style.display = 'flex';
                    document.getElementById('mainContent').style.display = 'none';
                    const userInfo = document.getElementById('userInfo');
                    const userInfoSpan = userInfo ? userInfo.querySelector('span') : null;
                    if (userInfoSpan) userInfoSpan.textContent = '';
                    if (userInfo) userInfo.style.display = 'none';
                    const logoutBtn = document.getElementById('logoutBtn');
                    if (logoutBtn) logoutBtn.style.display = 'none';
                }
            });
            
            // 로그인 함수
            window.login = async function() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    document.getElementById('loginError').textContent = '';
                } catch (error) {
                    document.getElementById('loginError').textContent = '이메일 주소 및 비밀번호를 입력해주세요.';
                }
            };
            
            // 로그아웃 함수
            window.logout = function() {
                signOut(auth);
            };
        </script>
        <style>
            * {
                box-sizing: border-box;
            }

            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 20px;
                background-color: #f8f9fa;
                line-height: 1.45;
                -webkit-text-size-adjust: 100%;
            }

            /* 로그인 모달 스타일 */
            .login-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            }

            .login-container {
                background: white;
                padding: 40px;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                width: 100%;
                max-width: 400px;
                text-align: center;
            }

            .login-container h2 {
                margin: 0 0 30px 0;
                color: #333;
                font-size: 24px;
            }

            .login-input {
                width: 100%;
                padding: 12px;
                margin: 10px 0;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 16px;
            }

            .login-btn {
                width: 100%;
                padding: 12px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 16px;
                cursor: pointer;
                margin-top: 20px;
            }

            .login-btn:hover {
                background: #0056b3;
            }

            .login-error {
                color: #dc3545;
                margin-top: 10px;
                font-size: 14px;
            }

            .user-info {
                background: transparent;
                padding: 0;
                border-radius: 0;
                margin: 0;
                display: flex;
                gap: 12px;
                align-items: center;
            }

            .logout-btn {
                background: #dc3545;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
            }

            .logout-btn:hover {
                background: #c82333;
            }

            .header {
                background: white;
                padding: 28px;
                border-radius: 16px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
                margin-bottom: 24px;
                border: 1px solid #f1f3f4;
                position: relative;
            }

            .header h1 {
                margin: 0 0 20px 0;
                color: #212529;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 24px;
                font-weight: 600;
            }

            .header-stats {
                display: flex;
                gap: 32px;
                margin-bottom: 20px;
                padding: 20px;
                background: #f8f9fa;
                border: 1px solid #e9ecef;
                border-radius: 12px;
                color: #333;
            }

            .stats-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
                flex: 1;
            }

            .stats-item .stats-label {
                font-size: 13px;
                color: #6c757d;
                margin-bottom: 6px;
                font-weight: 500;
            }

            .stats-item .stats-number {
                font-size: 24px;
                font-weight: 700;
                color: #212529;
            }

            .status-bar {
                display: flex;
                justify-content: flex-end;
                align-items: center;
            }

            .status-indicator {
                display: inline-block;
                width: 16px;
                height: 16px;
                border-radius: 50%;
                margin-left: 12px;
                vertical-align: middle;
                border: 2px solid #ddd;
                animation: pulse 2s infinite;
            }

            .status-indicator.connected {
                background-color: #28a745;
                border-color: #28a745;
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
                animation: pulse 2s infinite;
            }

            .status-indicator.disconnected {
                background-color: #dc3545;
                border-color: #dc3545;
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
                animation: pulse-disconnected 2s infinite;
            }

            @keyframes pulse {
                0% {
                    box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
                }
            }

            @keyframes pulse-disconnected {
                0% {
                    box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
                }
            }

            .controls {
                display: flex;
                gap: 10px;
            }

            .btn {
                padding: 12px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                min-height: 44px;
                transition: all 0.2s ease;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
                font-weight: 500;
            }

            .btn-primary {
                background-color: #007bff;
                color: white;
            }

            .btn-primary:hover {
                background-color: #0056b3;
                transform: translateY(-1px);
            }

            .btn-success {
                background-color: #6fcf97;
                color: white;
            }

            .btn-success:hover {
                background-color: #5ab885;
                transform: translateY(-1px);
            }

            .btn-info {
                background-color: #6fcf97;
                color: white;
            }

            .btn-info:hover {
                background-color: #5ab885;
                transform: translateY(-1px);
            }

            .btn-warning {
                background-color: #ffc107;
                color: #212529;
            }

            .btn-warning:hover {
                background-color: #e0a800;
                transform: translateY(-1px);
            }

            .main-content {
                display: block;
                width: 100%;
            }

            .orders-section {
                background: white;
                border-radius: 16px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
                overflow: hidden;
                border: 1px solid #f1f3f4;
            }

            .section-header {
                padding: 24px;
                border-bottom: 1px solid #f1f3f4;
                background-color: #fafbfc;
            }

            .section-header h2 {
                margin: 0;
                color: #212529;
                font-size: 18px;
                font-weight: 600;
            }

            .filters {
                display: flex;
                flex-direction: column;
                gap: 12px;
                margin-top: 10px;
            }

            .search-fields {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            .search-input {
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
                min-width: 200px;
                flex: 1;
            }

            .search-input:focus {
                outline: none;
                border-color: #007bff;
                box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
            }

            .filter-selects {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            .filter-select {
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
            }

            .table-container {
                overflow-x: auto;
                max-height: 600px;
                overflow-y: auto;
            }

            .orders-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 14px;
            }

            .orders-table th {
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                padding: 12px 8px;
                text-align: left;
                font-weight: 600;
                color: #495057;
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .orders-table td {
                border: 1px solid #dee2e6;
                padding: 8px;
                vertical-align: top;
            }

            .status-badge {
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 500;
            }

            .status-접수 {
                background-color: #fff3cd;
                color: #856404;
            }

            .status-배송중 {
                background-color: #d1ecf1;
                color: #0c5460;
            }

            .status-배송완료 {
                background-color: #d4edda;
                color: #155724;
            }

            .status-취소 {
                background-color: #f5c6cb;
                color: #721c24;
            }

            .order-type-badge {
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 500;
                background-color: #e3f2fd;
                color: #1976d2;
            }

            .status-select {
                padding: 4px 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 12px;
            }

            .sidebar {
                background: white;
                border-radius: 16px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
                padding: 24px;
                border: 1px solid #f1f3f4;
            }

            .recent-orders {
                margin-top: 20px;
            }

            .recent-orders h3 {
                margin: 0 0 16px 0;
                color: #212529;
                font-size: 16px;
                font-weight: 600;
            }

            .recent-order-item {
                padding: 12px;
                border: 1px solid #f1f3f4;
                border-radius: 8px;
                margin-bottom: 12px;
                background-color: #fafbfc;
                transition: all 0.2s ease;
            }

            .recent-order-item:hover {
                border-color: #e1e5e9;
                background-color: #f8f9fa;
            }

            /* SVG Icon Styles */
            .inline-icon {
                width: 18px;
                height: 18px;
                vertical-align: middle;
                margin-right: 6px;
            }

            .recent-order-item h4 {
                margin: 0 0 5px 0;
                font-size: 14px;
                color: #333;
            }

            .recent-order-item p {
                margin: 0;
                font-size: 12px;
                color: #666;
            }

            /* 자동 삭제 경고 스타일 */
            .auto-delete-warning {
                display: flex;
                align-items: center;
                gap: 8px;
                background-color: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 8px;
                padding: 12px 16px;
                margin-top: 12px;
                color: #856404;
                font-size: 14px;
                line-height: 1.4;
            }

            .auto-delete-warning .inline-icon {
                flex-shrink: 0;
                width: 20px;
                height: 20px;
            }

            .auto-delete-warning span {
                flex: 1;
            }

            /* 일괄 처리 도구 스타일 */
            .bulk-actions {
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 16px;
                margin-bottom: 16px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 12px;
            }

            .bulk-actions-info {
                font-weight: 600;
                color: #495057;
            }

            .bulk-actions-buttons {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }

            .btn-sm {
                padding: 8px 12px;
                font-size: 12px;
                min-height: 36px;
            }

            /* 체크박스 스타일 */
            .order-checkbox {
                width: 16px;
                height: 16px;
                cursor: pointer;
            }

            #selectAll {
                width: 16px;
                height: 16px;
                cursor: pointer;
            }

            @media (max-width: 768px) {
                body {
                    padding: 8px;
                    font-size: 13px;
                }

                .header {
                    padding: 12px;
                    border-radius: 12px;
                }

                .header h1 {
                    font-size: 20px;
                    margin-bottom: 16px;
                }

                .header-stats {
                    flex-direction: column;
                    gap: 10px;
                    padding: 12px;
                }

                .stats-item {
                    flex-direction: row;
                    justify-content: space-between;
                    width: 100%;
                }

                .stats-item .stats-number {
                    font-size: 16px;
                }

                .stats-item .stats-label {
                    font-size: 11px;
                }

                .main-content {
                    grid-template-columns: 1fr;
                    gap: 12px;
                }

                .filters {
                    flex-direction: column;
                    gap: 8px;
                }

                .search-fields {
                    flex-direction: column;
                    gap: 8px;
                }

                .search-input {
                    min-width: auto;
                    width: 100%;
                }

                .filter-selects {
                    flex-direction: column;
                    gap: 8px;
                }

                .controls {
                    flex-direction: column;
                    gap: 8px;
                }

                .orders-table {
                    font-size: 11px;
                }

                .orders-table th,
                .orders-table td {
                    padding: 4px 2px;
                }

                .btn {
                    padding: 8px 12px;
                    min-height: 40px;
                    font-size: 13px;
                }
            }

            /* Simple Footer */
            .simple-footer {
                margin-top: 40px;
                padding: 20px 0;
                text-align: center;
                border-top: 1px solid #e9ecef;
            }

            .simple-footer a {
                color: #6c757d;
                text-decoration: none;
                font-size: 12px;
                transition: color 0.2s ease;
            }

            .simple-footer a:hover {
                color: #495057;
            }
        </style>
    </head>
    <body>
        <!-- 로그인 모달 -->
        <div id="loginModal" class="login-modal" style="display: none;">
            <div class="login-container">
                <h2>관리자 로그인</h2>
                <input type="email" id="loginEmail" class="login-input" placeholder="이메일 주소" required>
                <input type="password" id="loginPassword" class="login-input" placeholder="비밀번호" required>
                <button onclick="login()" class="login-btn">로그인</button>
                <div id="loginError" class="login-error"></div>
            </div>
        </div>
        
        <script>
            // Enter 키로 로그인
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        </script>

        <!-- 사용자 정보 및 로그아웃 버튼 -->
        <!-- 위치를 헤더 내부로 이동 (h1과 좌우 정렬) -->

        <!-- 메인 콘텐츠 -->
        <div id="mainContent" style="display: none;">
        <!-- 상단 푸터 -->
        <div
            class="top-footer"
            style="
                background: #f8f9fa;
                border-bottom: 1px solid #e9ecef;
                padding: 8px 0;
                text-align: center;
                position: sticky;
                top: 0;
                z-index: 1000;
            "
        >
            <a
                href="https://cx-tech-builder.netlify.app/"
                target="_blank"
                style="
                    color: #6c757d;
                    text-decoration: none;
                    font-size: 12px;
                    transition: color 0.2s ease;
                "
            >
                Powered by CX Tech Builder
            </a>
        </div>

        <div class="header">
            <div class="header-title-row" style="display:flex; align-items:center; justify-content:space-between; gap:16px;">
            <h1 style="margin:0;">
                <svg
                    class="inline-icon"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                >
                    <path
                        d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                    />
                </svg>
                0000셀러 주문 접수 관리자<span
                    id="status"
                    class="status-indicator disconnected"
                ></span>
            </h1>
            <div id="userInfo" class="user-info" style="display:none; position:static; gap:8px;">
                <span style="font-size:14px; color:#495057;"></span>
                <button id="logoutBtn" onclick="logout()" class="btn btn-primary" style="min-height:36px; padding:8px 12px;">로그아웃</button>
            </div>
            </div>
            <div class="header-stats">
                <div class="stats-item">
                    <span class="stats-label">오늘 신규주문</span>
                    <span class="stats-number" id="todayNewOrders">0</span>
                </div>
                                 <div class="stats-item">
                     <span class="stats-label">교환접수 진행중</span>
                     <span class="stats-number" id="todayExchangeRequests"
                         >0</span
                     >
                 </div>
                 <div class="stats-item">
                     <span class="stats-label">반품접수 진행중</span>
                     <span class="stats-number" id="todayReturnRequests">0</span>
                 </div>
                 <div class="stats-item">
                     <span class="stats-label">취소 요청 진행중</span>
                     <span class="stats-number" id="todayCancelRequests">0</span>
                 </div>
            </div>
            <div class="status-bar">
                <div class="controls">
                    <button
                        class="btn btn-warning"
                        onclick="filterNewOrdersInProgress()"
                    >
                        <svg
                            class="inline-icon"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                        >
                            <path
                                d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                            />
                        </svg>
                        신규주문 진행중
                    </button>
                    <button
                        class="btn btn-secondary"
                        onclick="filterExchangeReturnInProgress()"
                    >
                        <svg
                            class="inline-icon"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                        >
                            <path
                                d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"
                            />
                        </svg>
                        교환/반품/취소 진행중
                    </button>
                    <button class="btn btn-secondary" onclick="showAllOrders()">
                        <svg
                            class="inline-icon"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                        >
                            <path
                                d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"
                            />
                        </svg>
                        전체 보기
                    </button>
                    <button class="btn btn-info" onclick="exportToExcelFull()">
                        <svg
                            class="inline-icon"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                        >
                            <path
                                d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"
                            />
                        </svg>
                        전체 내보내기(엑셀)
                    </button>
                    <button
                        class="btn btn-outline"
                        onclick="openInvoiceUploadModal()"
                    >
                        <svg
                            class="inline-icon"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                        >
                            <path
                                d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"
                            />
                        </svg>
                        송장 업로드
                    </button>
                    <button class="btn btn-primary" onclick="refreshOrders()">
                        <svg
                            class="inline-icon"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                        >
                            <path
                                d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"
                            />
                        </svg>
                        새로고침
                    </button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="orders-section">
                <div class="section-header">
                    <h2>
                        <svg
                            class="inline-icon"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                        >
                            <path
                                d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"
                            />
                        </svg>
                        주문 목록
                    </h2>
                    <div class="auto-delete-warning">
                        <svg
                            class="inline-icon"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                            style="color: #dc3545"
                        >
                            <path
                                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
                            />
                        </svg>
                        <span
                            >⚠️ 주문 데이터는 7일이 지나면 자동으로 삭제됩니다.
                            <span
                                id="deletionDateInfo"
                                style="font-weight: bold; color: #e74c3c"
                            ></span>
                            중요한 데이터는 Excel로 다운로드하여
                            백업하세요.</span
                        >
                    </div>
                    <div
                        class="auto-complete-info"
                        style="
                            margin-top: 8px;
                            padding: 8px 12px;
                            background: #f8f9fa;
                            font-size: 12px;
                            color: #6c757d;
                        "
                    >
                        <svg
                            class="inline-icon"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                            style="color: #6c757d"
                        >
                            <path
                                d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"
                            />
                        </svg>
                        <span
                            >✅ 송장번호 등록 후 3영업일(주말/공휴일 제외)이
                            지나면 자동으로 배송완료 처리됩니다.</span
                        >
                    </div>

                    <!-- 현재 필터 상태 표시 -->
                    <div
                        id="currentFilterStatus"
                        style="
                            margin-top: 8px;
                            padding: 8px 12px;
                            background: #e3f2fd;
                            font-size: 12px;
                            color: #1976d2;
                            display: none;
                        "
                    >
                        <svg
                            class="inline-icon"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                            style="color: #1976d2"
                        >
                            <path
                                d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"
                            />
                        </svg>
                        <span id="filterStatusText"
                            >현재 필터가 적용되어 있습니다.</span
                        >
                    </div>

                                         <!-- 관련 주문 모달 -->
                     <div
                         id="relatedOrdersModal"
                         style="
                             display: none;
                             position: fixed;
                             inset: 0;
                             background: rgba(0, 0, 0, 0.4);
                             align-items: center;
                             justify-content: center;
                             z-index: 2000;
                         "
                     >
                         <div
                             style="
                                 background: #fff;
                                 padding: 24px;
                                 border-radius: 12px;
                                 width: 90%;
                                 max-width: 1200px;
                                 max-height: 90vh;
                                 overflow-y: auto;
                             "
                         >
                             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                 <h3 style="margin: 0; color: #212529;">
                                     <svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor" style="color: #007bff;">
                                         <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                                     </svg>
                                     원주문번호: <span id="modalOrderNumber" style="color: #007bff; font-weight: bold;"></span>
                                 </h3>
                                 <button
                                     class="btn"
                                     onclick="closeRelatedOrdersModal()"
                                     style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;"
                                 >
                                     ✕ 닫기
                                 </button>
                             </div>
                             
                             <div id="relatedOrdersContent">
                                 <!-- 관련 주문 데이터가 여기에 표시됩니다 -->
                             </div>
                         </div>
                     </div>

                     <!-- 송장 업로드 모달 -->
                     <div
                         id="invoiceUploadModal"
                         style="
                             display: none;
                             position: fixed;
                             inset: 0;
                             background: rgba(0, 0, 0, 0.4);
                             align-items: center;
                             justify-content: center;
                             z-index: 2000;
                         "
                     >
                        <div
                            style="
                                background: #fff;
                                padding: 20px;
                                border-radius: 10px;
                                width: 420px;
                                max-width: 90%;
                            "
                        >
                            <h3 style="margin-top: 0">송장번호 업로드</h3>
                            <p style="color: #666; font-size: 13px">
                                엑셀 양식: 주문번호 / 택배사 / 송장번호
                            </p>
                            <div
                                style="
                                    display: flex;
                                    gap: 8px;
                                    margin: 10px 0 16px;
                                "
                            >
                                <button
                                    class="btn btn-secondary btn-sm"
                                    onclick="downloadInvoiceTemplate()"
                                >
                                    양식 내려받기
                                </button>
                                <label
                                    class="btn btn-primary btn-sm"
                                    style="cursor: pointer; display: inline-flex; align-items: center; justify-content: center;"
                                >
                                    파일 선택
                                    <input
                                        id="invoiceFileInput"
                                        type="file"
                                        accept=".xlsx,.xls"
                                        style="display: none"
                                        onchange="previewInvoiceFile()"
                                    />
                                </label>
                                <button
                                    id="uploadBtn"
                                    class="btn btn-success btn-sm"
                                    onclick="startInvoiceImport()"
                                    disabled
                                >
                                    업로드
                                </button>
                            </div>
                            <div
                                id="invoiceImportStatus"
                                style="font-size: 12px; color: #555"
                            ></div>
                            <div
                                id="invoicePreview"
                                style="
                                    margin: 10px 0;
                                    padding: 10px;
                                    background: #f8f9fa;
                                    border-radius: 4px;
                                    display: none;
                                "
                            ></div>
                            <div style="text-align: right; margin-top: 12px">
                                <button
                                    class="btn"
                                    onclick="closeInvoiceUploadModal()"
                                >
                                    닫기
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="filters">
                        <div class="search-fields">
                            <input
                                type="text"
                                id="phoneSearch"
                                class="search-input"
                                placeholder="휴대폰번호 검색"
                                onkeyup="filterOrders()"
                            />
                            <input
                                type="text"
                                id="orderNumberSearch"
                                class="search-input"
                                placeholder="주문번호 검색"
                                onkeyup="filterOrders()"
                            />
                        </div>

                        <div class="filter-selects">
                            <select
                                id="orderTypeFilter"
                                class="filter-select"
                                onchange="filterOrders()"
                            >
                                <option value="">전체 주문유형</option>
                                <option value="신규주문">신규주문</option>
                                <option value="교환">교환</option>
                                <option value="반품">반품</option>
                                <option value="취소">취소</option>
                            </select>
                            <select
                                id="statusFilter"
                                class="filter-select"
                                onchange="filterOrders()"
                            >
                                <option value="">전체 배송상태</option>
                                <option value="접수">접수</option>
                                <option value="배송중">배송중</option>
                                <option value="배송완료">배송완료</option>
                                <option value="취소">취소</option>
                            </select>
                            <select
                                id="dateFilter"
                                class="filter-select"
                                onchange="filterOrders()"
                            >
                                <option value="">전체 기간</option>
                                <option value="recent3days" selected>최근 3일</option>
                                <option value="today">오늘</option>
                                <option value="week">이번 주</option>
                            </select>
                            <select
                                id="itemsPerPageFilter"
                                class="filter-select"
                                onchange="changeItemsPerPage(this.value)"
                            >
                                <option value="30" selected>30개씩 보기</option>
                                <option value="50">50개씩 보기</option>
                                <option value="100">100개씩 보기</option>
                            </select>
                            <button
                                class="btn btn-primary btn-sm"
                                onclick="refreshOrders()"
                            >
                                <svg
                                    class="inline-icon"
                                    viewBox="0 0 24 24"
                                    fill="currentColor"
                                >
                                    <path
                                        d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"
                                    />
                                </svg>
                                새로고침
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <!-- 일괄 처리 도구 -->
                    <div class="bulk-actions" style="display: none">
                        <div class="bulk-actions-info">
                            <span id="selectedCount">0개 선택됨</span>
                        </div>
                        <div class="bulk-actions-buttons">
                            <button
                                class="btn btn-success btn-sm"
                                onclick="bulkUpdateStatus('배송완료')"
                            >
                                <svg
                                    class="inline-icon"
                                    viewBox="0 0 24 24"
                                    fill="currentColor"
                                >
                                    <path
                                        d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"
                                    />
                                </svg>
                                선택된 주문 배송완료
                            </button>
                            <button
                                class="btn btn-warning btn-sm"
                                onclick="bulkUpdateStatus('배송중')"
                            >
                                <svg
                                    class="inline-icon"
                                    viewBox="0 0 24 24"
                                    fill="currentColor"
                                >
                                    <path
                                        d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                                    />
                                </svg>
                                선택된 주문 배송중
                            </button>
                            <button
                                class="btn btn-danger btn-sm"
                                onclick="bulkUpdateStatus('취소')"
                            >
                                <svg
                                    class="inline-icon"
                                    viewBox="0 0 24 24"
                                    fill="currentColor"
                                >
                                    <path
                                        d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                                    />
                                </svg>
                                선택된 주문 취소
                            </button>
                        </div>
                    </div>

                    <table class="orders-table" id="ordersTable">
                        <thead>
                            <tr>
                                <th>
                                    <input
                                        type="checkbox"
                                        id="selectAll"
                                        onchange="toggleSelectAll()"
                                        title="전체 선택"
                                    />
                                </th>
                                <th>주문번호</th>
                                <th>주문시간</th>
                                <th>입금자명</th>
                                <th>연락처</th>
                                <th>주문유형</th>
                                <th>기존주문번호</th>
                                <th>구매제품</th>
                                <th>주소</th>
                                <th>상세주소</th>
                                <th>배송메세지</th>
                                <th>배송상태</th>
                                <th>택배사</th>
                                <th>송장번호</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- 주문 데이터가 여기에 동적으로 추가됩니다 -->
                        </tbody>
                    </table>

                    <!-- 페이지 정보 및 페이지네이션 -->
                    <div
                        class="pagination-container"
                        style="margin-top: 20px; text-align: center"
                    >
                        <div
                            id="pageInfo"
                            style="
                                margin-bottom: 15px;
                                color: #666;
                                font-size: 14px;
                            "
                        >
                            <!-- 페이지 정보가 여기에 표시됩니다 -->
                        </div>
                        <div
                            class="pagination-controls"
                            style="
                                display: flex;
                                justify-content: center;
                                gap: 10px;
                                align-items: center;
                            "
                        >
                            <button
                                class="btn btn-outline-primary btn-sm"
                                onclick="changePage(1)"
                                id="firstPage"
                            >
                                처음
                            </button>
                            <button
                                class="btn btn-outline-primary btn-sm"
                                onclick="changePage(currentPage - 1)"
                                id="prevPage"
                            >
                                이전
                            </button>
                            <span id="pageNumbers" style="margin: 0 15px">
                                <!-- 페이지 번호가 여기에 표시됩니다 -->
                            </span>
                            <button
                                class="btn btn-outline-primary btn-sm"
                                onclick="changePage(currentPage + 1)"
                                id="nextPage"
                            >
                                다음
                            </button>
                            <button
                                class="btn btn-outline-primary btn-sm"
                                onclick="changePage(Math.ceil(allFilteredData.length / itemsPerPage))"
                                id="lastPage"
                            >
                                마지막
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Simple Footer -->
        <footer class="simple-footer">
            <!-- cx-tech-builder 링크는 주문 목록 섹션으로 이동됨 -->
        </footer>

        <!-- Firebase SDK -->
        <script type="module">
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
            import {
                getDatabase,
                ref,
                onValue,
                set,
                query,
                orderByChild,
                get,
            } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
            import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";

            // Firebase 설정은 이미 head에서 초기화됨
            const database = getDatabase(window.app);

            // DOM 요소들
            const statusDiv = document.getElementById("status");
            const ordersTableBody = document.getElementById("ordersTableBody");
            const recentOrdersList =
                document.getElementById("recentOrdersList");

            // 페이지네이션 관련 변수
            let currentPage = 1;
            let itemsPerPage = 30;
            let allFilteredData = [];

            // 필터 상태 저장 변수
            let currentFilterState = {
                type: null, // 'newOrders', 'exchangeReturn', 'all'
                filters: {},
                searchTerms: {},
            };

            // 연결 상태 확인
            const connectedRef = ref(database, ".info/connected");
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    statusDiv.className = "status-indicator connected";
                } else {
                    statusDiv.className = "status-indicator disconnected";
                }
            });

            // 삭제 예정일 계산 및 표시
            function updateDeletionDateInfo() {
                const today = new Date();
                const deletionDate = new Date(
                    today.getTime() + 7 * 24 * 60 * 60 * 1000
                ); // 7일 후

                const deletionDateInfo =
                    document.getElementById("deletionDateInfo");
                if (deletionDateInfo) {
                    const formattedDate = deletionDate.toLocaleDateString(
                        "ko-KR",
                        {
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                            weekday: "long",
                        }
                    );
                    deletionDateInfo.textContent = `오늘 기준 ${formattedDate} 삭제 예정`;
                }
            }

            // 실시간 주문 데이터 리스너
            const ordersRef = ref(database, "orders");
            const ordersQuery = query(ordersRef, orderByChild("createdAt"));
            onValue(ordersQuery, (snapshot) => {
                const data = snapshot.val();

                // 필터 상태가 있으면 해당 필터 적용, 없으면 전체 표시
                if (
                    currentFilterState.type &&
                    currentFilterState.type !== "all"
                ) {
                    applyCurrentFilter(data);
                } else {
                    updateOrdersTable(data);
                    updateStats(data);
                    updateRecentOrders(data);
                }

                // 7일이 지난 주문 자동 삭제
                deleteOldOrders(data);

                // 3일이 지난 배송중 주문 자동 완료 처리
                autoCompleteShippedOrders(data);

                // 삭제 예정일 정보 업데이트
                updateDeletionDateInfo();
            });

            // 현재 필터 상태를 적용하는 함수
            function applyCurrentFilter(data) {
                if (!data || !currentFilterState.type) return;

                let filteredEntries = Object.entries(data);

                switch (currentFilterState.type) {
                    case "newOrders":
                        filteredEntries = filteredEntries.filter(
                            ([id, order]) => {
                                return (
                                    order.orderType === "신규주문" &&
                                    (order.status === "접수" ||
                                        order.status === "배송중")
                                );
                            }
                        );
                        break;
                    case "exchangeReturn":
                        filteredEntries = filteredEntries.filter(
                            ([id, order]) => {
                                return (
                                    ["교환", "반품", "취소"].includes(
                                        order.orderType
                                    ) &&
                                    (order.status === "접수" ||
                                        order.status === "배송중")
                                );
                            }
                        );
                        break;
                    default:
                        break;
                }

                // 필터링된 데이터로 테이블 업데이트 (페이지네이션 유지)
                const filteredData = {};
                filteredEntries.forEach(([id, order]) => {
                    filteredData[id] = order;
                });

                                 // 페이지네이션 유지 (리셋하지 않음)
                 allFilteredData = Object.entries(filteredData);
                 updatePagination();
                 // 통계는 항상 전체 데이터로 업데이트 (미처리 체크 개념 유지)
                 updateStats(data);
                 updateRecentOrders(filteredData);

                // 필터 상태 표시 업데이트
                updateFilterStatusDisplay();
            }

            // 필터 상태 표시 업데이트
            function updateFilterStatusDisplay() {
                const filterStatus = document.getElementById(
                    "currentFilterStatus"
                );
                const filterStatusText =
                    document.getElementById("filterStatusText");

                if (
                    currentFilterState.type &&
                    currentFilterState.type !== "all"
                ) {
                    let statusText = "";
                    switch (currentFilterState.type) {
                        case "newOrders":
                            statusText =
                                "신규주문 진행중 필터가 적용되어 있습니다.";
                            break;
                        case "exchangeReturn":
                            statusText =
                                "교환/반품/취소 진행중 필터가 적용되어 있습니다.";
                            break;
                    }
                    filterStatusText.textContent = statusText;
                    filterStatus.style.display = "block";
                } else {
                    filterStatus.style.display = "none";
                }
            }

                         // 관련 주문 모달 제어
             window.showRelatedOrdersModal = async function (orderNumber) {
                 try {
                     // 모달 표시
                     document.getElementById("relatedOrdersModal").style.display = "flex";
                     document.getElementById("modalOrderNumber").textContent = orderNumber;
                     
                     // 로딩 표시
                     document.getElementById("relatedOrdersContent").innerHTML = 
                         '<div style="text-align: center; padding: 40px; color: #666;">데이터를 불러오는 중...</div>';
                     
                     // 관련 주문 데이터 조회
                     const allSnap = await get(ref(database, "orders"));
                     const all = allSnap.val() || {};
                     
                     // 해당 주문번호와 관련된 모든 주문 찾기
                     const relatedOrders = [];
                     
                     // 1. 원주문 찾기
                     const originalOrder = Object.values(all).find(order => 
                         order && order.orderNumber === orderNumber
                     );
                     
                     if (originalOrder) {
                         relatedOrders.push({
                             id: Object.keys(all).find(key => all[key] === originalOrder),
                             order: originalOrder,
                             type: "원주문"
                         });
                     }
                     
                     // 2. 관련 클레임들 찾기 (교환/반품/취소)
                     Object.entries(all).forEach(([id, order]) => {
                         if (order && order.existingOrderNumber === orderNumber) {
                             relatedOrders.push({
                                 id: id,
                                 order: order,
                                 type: "클레임"
                             });
                         }
                     });
                     
                     // 주문 시간순으로 정렬
                     relatedOrders.sort((a, b) => a.order.createdAt - b.order.createdAt);
                     
                     // 모달 내용 업데이트
                     updateRelatedOrdersModal(relatedOrders);
                     
                 } catch (error) {
                     console.error("관련 주문 조회 오류:", error);
                     document.getElementById("relatedOrdersContent").innerHTML = 
                         '<div style="text-align: center; padding: 40px; color: #dc3545;">데이터 조회 중 오류가 발생했습니다.</div>';
                 }
             };
             
             window.closeRelatedOrdersModal = function () {
                 document.getElementById("relatedOrdersModal").style.display = "none";
             };
             
             // 관련 주문 모달 내용 업데이트
             function updateRelatedOrdersModal(relatedOrders) {
                 if (relatedOrders.length === 0) {
                     document.getElementById("relatedOrdersContent").innerHTML = 
                         '<div style="text-align: center; padding: 40px; color: #666;">관련된 주문이 없습니다.</div>';
                     return;
                 }
                 
                 let modalHTML = `
                     <div style="margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                         <div style="font-weight: 600; color: #495057; margin-bottom: 8px;">📊 관련 주문 요약</div>
                         <div style="display: flex; gap: 20px; font-size: 14px;">
                             <span>총 ${relatedOrders.length}건</span>
                             <span>원주문: ${relatedOrders.filter(o => o.type === "원주문").length}건</span>
                             <span>클레임: ${relatedOrders.filter(o => o.type === "클레임").length}건</span>
                         </div>
                     </div>
                     
                     <div style="overflow-x: auto;">
                         <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                             <thead>
                                 <tr style="background: #f8f9fa;">
                                     <th style="padding: 12px 8px; border: 1px solid #dee2e6; text-align: left;">유형</th>
                                     <th style="padding: 12px 8px; border: 1px solid #dee2e6; text-align: left;">주문번호</th>
                                     <th style="padding: 12px 8px; border: 1px solid #dee2e6; text-align: left;">주문시간</th>
                                     <th style="padding: 12px 8px; border: 1px solid #dee2e6; text-align: left;">입금자명</th>
                                     <th style="padding: 12px 8px; border: 1px solid #dee2e6; text-align: left;">연락처</th>
                                     <th style="padding: 12px 8px; border: 1px solid #dee2e6; text-align: left;">주문유형</th>
                                     <th style="padding: 12px 8px; border: 1px solid #dee2e6; text-align: left;">구매제품</th>
                                     <th style="padding: 12px 8px; border: 1px solid #dee2e6; text-align: left;">배송상태</th>
                                     <th style="padding: 12px 8px; border: 1px solid #dee2e6; text-align: left;">작업</th>
                                 </tr>
                             </thead>
                             <tbody>
                 `;
                 
                 relatedOrders.forEach(({id, order, type}) => {
                     const orderDate = new Date(order.createdAt);
                     const typeBadge = type === "원주문" ? 
                         '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">원주문</span>' :
                         '<span style="background: #ffc107; color: #212529; padding: 4px 8px; border-radius: 12px; font-size: 11px;">클레임</span>';
                     
                     modalHTML += `
                         <tr style="border-bottom: 1px solid #f1f3f4;">
                             <td style="padding: 12px 8px; border: 1px solid #dee2e6;">${typeBadge}</td>
                             <td style="padding: 12px 8px; border: 1px solid #dee2e6;"><strong>${order.orderNumber}</strong></td>
                             <td style="padding: 12px 8px; border: 1px solid #dee2e6;">${orderDate.toLocaleString("ko-KR")}</td>
                             <td style="padding: 12px 8px; border: 1px solid #dee2e6;">${order.customerName || ""}</td>
                             <td style="padding: 12px 8px; border: 1px solid #dee2e6;">${order.phone || ""}</td>
                             <td style="padding: 12px 8px; border: 1px solid #dee2e6;">
                                 <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                                     ${order.orderType || "신규주문"}
                                 </span>
                             </td>
                             <td style="padding: 12px 8px; border: 1px solid #dee2e6;">${order.product || ""} (${order.quantity || 0}개)</td>
                             <td style="padding: 12px 8px; border: 1px solid #dee2e6;">
                                 <span style="background: ${getStatusColor(order.status)}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                                     ${order.status}
                                 </span>
                             </td>
                             <td style="padding: 12px 8px; border: 1px solid #dee2e6;">
                                 <select onchange="updateOrderStatusFromModal('${id}', this.value)" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                     <option value="접수" ${order.status === "접수" ? "selected" : ""}>접수</option>
                                     <option value="배송중" ${order.status === "배송중" ? "selected" : ""}>배송중</option>
                                     <option value="배송완료" ${order.status === "배송완료" ? "selected" : ""}>배송완료</option>
                                     <option value="취소" ${order.status === "취소" ? "selected" : ""}>취소</option>
                                 </select>
                             </td>
                         </tr>
                     `;
                 });
                 
                 modalHTML += `
                             </tbody>
                         </table>
                     </div>
                     
                     <div style="margin-top: 20px; padding: 16px; background: #e3f2fd; border-radius: 8px; border: 1px solid #bbdefb;">
                         <div style="font-weight: 600; color: #1976d2; margin-bottom: 8px;">💡 작업 팁</div>
                         <div style="font-size: 13px; color: #1976d2; line-height: 1.5;">
                             • 원주문과 관련 클레임들의 상태를 일괄적으로 관리할 수 있습니다.<br>
                             • 클레임이 진행 중인 경우 원주문 상태 변경 시 주의가 필요합니다.<br>
                             • 모든 관련 주문의 상태를 확인하고 일관성 있게 관리하세요.
                         </div>
                     </div>
                 `;
                 
                 document.getElementById("relatedOrdersContent").innerHTML = modalHTML;
             }
             
             // 상태별 색상 반환
             function getStatusColor(status) {
                 switch (status) {
                     case "접수": return "#ffc107";
                     case "배송중": return "#17a2b8";
                     case "배송완료": return "#28a745";
                     case "취소": return "#dc3545";
                     default: return "#6c757d";
                 }
             }
             
             // 모달에서 주문 상태 업데이트
             window.updateOrderStatusFromModal = async function (orderId, newStatus) {
                 try {
                     await updateOrderStatus(orderId, newStatus);
                     
                     // 모달 새로고침 (상태 변경 후 최신 데이터 반영)
                     const orderNumber = document.getElementById("modalOrderNumber").textContent;
                     await showRelatedOrdersModal(orderNumber);
                     
                 } catch (error) {
                     console.error("모달에서 상태 업데이트 오류:", error);
                     alert("상태 업데이트 중 오류가 발생했습니다.");
                 }
             };

             // 송장 업로드 모달 제어
             window.openInvoiceUploadModal = function () {
                 document.getElementById("invoiceUploadModal").style.display =
                     "flex";
                 document.getElementById("invoiceImportStatus").textContent = "";
                 document.getElementById("invoicePreview").style.display =
                     "none";
                 document.getElementById("uploadBtn").disabled = true;
                 const fileInput = document.getElementById("invoiceFileInput");
                 if (fileInput) fileInput.value = "";
             };
             window.closeInvoiceUploadModal = function () {
                 document.getElementById("invoiceUploadModal").style.display =
                     "none";
             };

            // 송장 양식 다운로드
            window.downloadInvoiceTemplate = function () {
                const headers = [
                    {
                        주문번호: "ORD20240101000000",
                        택배사: "CJ대한통운",
                        송장번호: "123456789012",
                    },
                ];
                const ws = XLSX.utils.json_to_sheet(headers);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "송장업로드양식");
                XLSX.writeFile(wb, "송장업로드_양식.xlsx");
            };

            // 파일 선택 후 미리보기
            window.previewInvoiceFile = async function () {
                const input = document.getElementById("invoiceFileInput");
                const preview = document.getElementById("invoicePreview");
                const uploadBtn = document.getElementById("uploadBtn");
                const status = document.getElementById("invoiceImportStatus");

                if (!input || !input.files || input.files.length === 0) {
                    preview.style.display = "none";
                    uploadBtn.disabled = true;
                    return;
                }

                try {
                    status.textContent = "파일 분석 중...";
                    preview.style.display = "none";

                    const file = input.files[0];
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    const sheetName = workbook.SheetNames[0];
                    const rows = XLSX.utils.sheet_to_json(
                        workbook.Sheets[sheetName],
                        { defval: "" }
                    );

                    if (rows.length === 0) {
                        status.textContent = "파일에 데이터가 없습니다.";
                        uploadBtn.disabled = true;
                        return;
                    }

                    // 데이터 분석
                    let validRows = 0,
                        invalidRows = 0;
                    const sampleData = [];

                    for (let i = 0; i < Math.min(rows.length, 5); i++) {
                        const row = rows[i];
                        const orderNumber = String(
                            row["주문번호"] || ""
                        ).trim();
                        const courier = String(row["택배사"] || "").trim();
                        const invoice = String(row["송장번호"] || "").trim();

                        if (orderNumber && courier && invoice) {
                            validRows++;
                            if (sampleData.length < 3) {
                                sampleData.push({
                                    orderNumber: orderNumber,
                                    courier: courier,
                                    invoice: invoice,
                                });
                            }
                        } else {
                            invalidRows++;
                        }
                    }

                    // 미리보기 표시
                    let previewHTML = `
                        <div style="margin-bottom:10px;">
                            <strong>📁 파일 분석 결과</strong>
                        </div>
                        <div style="font-size:12px; margin-bottom:8px;">
                            📊 총 ${rows.length}행, 유효 ${validRows}행, 오류 ${invalidRows}행
                        </div>
                    `;

                    if (sampleData.length > 0) {
                        previewHTML += `
                            <div style="font-size:12px; margin-bottom:8px;">
                                <strong>📋 샘플 데이터 (처음 3건):</strong>
                            </div>
                            <div style="font-size:11px; color:#666;">
                        `;

                        sampleData.forEach((item, index) => {
                            previewHTML += `
                                ${index + 1}. ${item.orderNumber} | ${
                                item.courier
                            } | ${item.invoice}<br>
                            `;
                        });

                        previewHTML += `</div>`;
                    }

                    if (invalidRows > 0) {
                        previewHTML += `
                            <div style="font-size:12px; color:#dc3545; margin-top:8px;">
                                ⚠️ ${invalidRows}행에 필수 데이터가 누락되어 있습니다.
                            </div>
                        `;
                    }

                    preview.innerHTML = previewHTML;
                    preview.style.display = "block";

                    // 업로드 버튼 활성화
                    uploadBtn.disabled = false;
                    status.textContent = `파일 준비 완료: ${rows.length}행 (${validRows}건 유효)`;
                } catch (error) {
                    console.error("파일 분석 오류:", error);
                    status.textContent = "파일 분석 중 오류가 발생했습니다.";
                    preview.style.display = "none";
                    uploadBtn.disabled = true;
                }
            };

            // 송장 업로드 처리
            window.startInvoiceImport = async function () {
                const input = document.getElementById("invoiceFileInput");
                const status = document.getElementById("invoiceImportStatus");
                if (!input || !input.files || input.files.length === 0) {
                    alert("업로드할 파일을 선택하세요.");
                    return;
                }
                try {
                    status.textContent = "처리 중...";
                    const file = input.files[0];
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    const sheetName = workbook.SheetNames[0];
                    const rows = XLSX.utils.sheet_to_json(
                        workbook.Sheets[sheetName],
                        { defval: "" }
                    );

                    // rows: [{ 주문번호, 택배사, 송장번호 }]
                    let updated = 0,
                        notFound = 0,
                        errors = 0,
                        claimWarnings = 0;
                    const claimWarningOrders = [];
                    const allSnap = await get(ref(database, "orders"));
                    const all = allSnap.val() || {};

                    const orderNumberToId = new Map();
                    Object.entries(all).forEach(([id, o]) => {
                        if (o && o.orderNumber)
                            orderNumberToId.set(o.orderNumber, id);
                    });

                    for (const row of rows) {
                        const orderNumber = String(
                            row["주문번호"] || ""
                        ).trim();
                        const courier = String(row["택배사"] || "").trim();
                        const invoice = String(row["송장번호"] || "").trim();
                        if (!orderNumber || !courier || !invoice) {
                            errors++;
                            continue;
                        }

                        const orderId = orderNumberToId.get(orderNumber);
                        if (!orderId) {
                            notFound++;
                            continue;
                        }

                        try {
                            const order = all[orderId];
                            if (!order) {
                                notFound++;
                                continue;
                            }

                            // 클레임 체크: 해당 주문에 대한 교환/반품/취소가 접수/배송중인지 확인
                            const relatedClaims = Object.values(all).filter(
                                (o) =>
                                    o &&
                                    o.existingOrderNumber ===
                                        order.orderNumber &&
                                    (o.orderType === "교환" ||
                                        o.orderType === "반품" ||
                                        o.orderType === "취소") &&
                                    (o.status === "접수" ||
                                        o.status === "배송중")
                            );

                            // 송장 정보 업데이트
                            await set(
                                ref(database, `orders/${orderId}/courier`),
                                courier
                            );
                            await set(
                                ref(
                                    database,
                                    `orders/${orderId}/invoiceNumber`
                                ),
                                invoice
                            );

                            // 클레임이 없으면 배송중으로 자동 전환
                            if (relatedClaims.length === 0) {
                                await set(
                                    ref(database, `orders/${orderId}/status`),
                                    "배송중"
                                );
                                // 배송 시작 시간 기록 (3일 후 자동 완료용)
                                await set(
                                    ref(
                                        database,
                                        `orders/${orderId}/shippingStartTime`
                                    ),
                                    Date.now()
                                );
                            } else {
                                // 클레임이 있으면 경고 누적 (송장 정보는 저장되지만 상태는 그대로)
                                claimWarnings++;
                                claimWarningOrders.push(order.orderNumber);
                                console.warn(
                                    `클레임 진행 중: ${order.orderNumber} (${relatedClaims.length}건)`
                                );
                            }

                            updated++;
                        } catch (e) {
                            errors++;
                        }
                    }

                    let message = `완료: ${updated}건 업데이트, ${notFound}건 미매칭, ${errors}건 오류`;

                    // 클레임 경고가 있으면 알럿에 포함
                    if (claimWarnings > 0) {
                        message += `\n\n⚠️ 클레임 진행 중인 주문 ${claimWarnings}건은 송장만 등록되고 배송중 처리되지 않았습니다.`;
                        const sample = claimWarningOrders
                            .slice(0, 5)
                            .join(", ");
                        if (sample)
                            message += `\n예: ${sample}${
                                claimWarningOrders.length > 5 ? " 외" : ""
                            }`;
                        message += `\n해당 주문의 교환/반품/취소 요청을 먼저 처리해주세요.`;
                    } else {
                        message += `\n\n✅ 정상 주문 ${updated}건은 송장 등록 후 3영업일 후 자동 배송완료 처리됩니다.`;
                    }

                    status.textContent = message.split("\n")[0]; // 첫 줄만 status에 표시
                    alert(message);

                    // 송장 업로드 후 현재 필터 상태 유지
                    // 실시간 리스너가 자동으로 필터를 적용함
                } catch (e) {
                    console.error(e);
                    alert("업로드 처리 중 오류가 발생했습니다.");
                }
            };

            // 페이지네이션 함수들
            function updatePagination() {
                const totalPages = Math.ceil(
                    allFilteredData.length / itemsPerPage
                );
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;

                // 현재 페이지 데이터만 표시
                const currentPageData = allFilteredData.slice(
                    startIndex,
                    endIndex
                );

                // 테이블 업데이트
                ordersTableBody.innerHTML = "";

                if (currentPageData.length === 0) {
                    ordersTableBody.innerHTML =
                        '<tr><td colspan="14" style="text-align: center; padding: 20px;">표시할 주문이 없습니다.</td></tr>';
                    return;
                }

                currentPageData.forEach(([id, order]) => {
                    const row = createOrderRow(id, order);
                    ordersTableBody.appendChild(row);
                });

                // 페이지 정보 표시
                updatePageInfo(totalPages);
            }

            function updatePageInfo(totalPages) {
                const pageInfo = document.getElementById("pageInfo");
                const pageNumbers = document.getElementById("pageNumbers");

                if (pageInfo) {
                    pageInfo.innerHTML = `
                        <span>총 ${allFilteredData.length}건 중 ${
                        (currentPage - 1) * itemsPerPage + 1
                    }-${Math.min(
                        currentPage * itemsPerPage,
                        allFilteredData.length
                    )}건 표시</span>
                        <span style="margin-left: 20px;">페이지 ${currentPage} / ${totalPages}</span>
                    `;
                }

                // 페이지 번호 버튼 생성
                if (pageNumbers && totalPages > 1) {
                    let pageButtons = "";
                    const startPage = Math.max(1, currentPage - 2);
                    const endPage = Math.min(totalPages, currentPage + 2);

                    for (let i = startPage; i <= endPage; i++) {
                        if (i === currentPage) {
                            pageButtons += `<button class="btn btn-primary btn-sm" style="margin: 0 2px;">${i}</button>`;
                        } else {
                            pageButtons += `<button class="btn btn-outline-primary btn-sm" style="margin: 0 2px;" onclick="changePage(${i})">${i}</button>`;
                        }
                    }
                    pageNumbers.innerHTML = pageButtons;
                } else if (pageNumbers) {
                    pageNumbers.innerHTML = "";
                }

                // 페이지네이션 버튼 활성화/비활성화
                updatePaginationButtons(totalPages);
            }

            function updatePaginationButtons(totalPages) {
                const firstPage = document.getElementById("firstPage");
                const prevPage = document.getElementById("prevPage");
                const nextPage = document.getElementById("nextPage");
                const lastPage = document.getElementById("lastPage");

                if (firstPage) firstPage.disabled = currentPage === 1;
                if (prevPage) prevPage.disabled = currentPage === 1;
                if (nextPage) nextPage.disabled = currentPage === totalPages;
                if (lastPage) lastPage.disabled = currentPage === totalPages;
            }

            function changePage(page) {
                const totalPages = Math.ceil(
                    allFilteredData.length / itemsPerPage
                );
                if (page >= 1 && page <= totalPages) {
                    currentPage = page;
                    updatePagination();
                }
            }

            function changeItemsPerPage(newItemsPerPage) {
                itemsPerPage = parseInt(newItemsPerPage);
                currentPage = 1; // 첫 페이지로 리셋
                updatePagination();
            }

            // 주문 테이블 업데이트
            function updateOrdersTable(data) {
                if (!data) {
                    allFilteredData = [];
                    updatePagination();
                    return;
                }

                const entries = Object.entries(data);
                allFilteredData = filterOrdersData(entries).sort((a, b) => {
                    const aTime = a[1]?.createdAt || 0;
                    const bTime = b[1]?.createdAt || 0;
                    return bTime - aTime; // 최신순
                });

                // 페이지네이션 업데이트
                currentPage = 1; // 첫 페이지로 리셋
                updatePagination();
            }

            // 주문 행 생성
            function createOrderRow(id, order) {
                const row = document.createElement("tr");
                const orderDate = new Date(order.createdAt);

                row.innerHTML = `
                <td>
                    <input type="checkbox" class="order-checkbox" value="${id}" data-status="${
                    order.status
                }">
                </td>
                <td><strong>${order.orderNumber}</strong></td>
                <td>${orderDate.toLocaleString("ko-KR")}</td>
                <td>${order.customerName}</td>
                <td>${order.phone}</td>
                <td><span class="order-type-badge">${
                    order.orderType || "신규주문"
                }</span></td>
                                 <td>
                     ${order.existingOrderNumber ? 
                         `<span class="existing-order-link" onclick="showRelatedOrdersModal('${order.existingOrderNumber}')" style="color: #007bff; cursor: pointer; text-decoration: underline;">${order.existingOrderNumber}</span>` 
                         : "-"
                     }
                 </td>
                <td>${order.product} (${order.quantity}개)</td>
                <td style="max-width: 150px; word-break: break-all;">${
                    order.address || ""
                }</td>
                <td style="max-width: 150px; word-break: break-all;">${
                    order.detailAddress || ""
                }</td>
                <td style="max-width: 150px; word-break: break-all;">${
                    order.memo || ""
                }${
                    order.refundAccount
                        ? `<br><br><strong>환불 계좌정보:</strong><br>${order.refundAccount}`
                        : ""
                }</td>
                <td>
                    <span class="status-badge status-${order.status}">${
                    order.status
                }</span>
                </td>
                <td style="max-width: 120px; word-break: break-all;">${
                    order.courier || ""
                }</td>
                <td style="max-width: 140px; word-break: break-all;">${
                    order.invoiceNumber || ""
                }</td>
                <td>
                    <select class="status-select" onchange="updateOrderStatus('${id}', this.value)">
                        <option value="접수" ${
                            order.status === "접수" ? "selected" : ""
                        }>접수</option>
                        <option value="배송중" ${
                            order.status === "배송중" ? "selected" : ""
                        }>배송중</option>
                        <option value="배송완료" ${
                            order.status === "배송완료" ? "selected" : ""
                        }>배송완료</option>
                        <option value="취소" ${
                            order.status === "취소" ? "selected" : ""
                        }>취소</option>
                    </select>
                </td>
            `;

                return row;
            }

            // 주문 상태 업데이트 (클레임 사전 확인 포함)
            window.updateOrderStatus = async function (orderId, newStatus) {
                try {
                    // 대상 주문 조회
                    const orderSnap = await get(
                        ref(database, `orders/${orderId}`)
                    );
                    const order = orderSnap.val();
                    if (!order) return;

                    // 배송중/배송완료로 변경하는 경우, 연계 클레임(교환/반품/취소) 진행 여부 확인
                    if (newStatus === "배송중" || newStatus === "배송완료") {
                        const allSnap = await get(ref(database, `orders`));
                        const all = allSnap.val() || {};
                        const relatedClaims = Object.values(all).filter(
                            (o) =>
                                o &&
                                o.existingOrderNumber === order.orderNumber &&
                                (o.orderType === "교환" ||
                                    o.orderType === "반품" ||
                                    o.orderType === "취소") &&
                                (o.status === "접수" || o.status === "배송중")
                        );

                        if (relatedClaims.length > 0) {
                            const proceed = confirm(
                                "새로운 클레임이 존재합니다.\n" +
                                    "해당 주문에 대해 교환/반품/취소 요청이 접수/진행 중일 수 있어요.\n" +
                                    `그래도 '${newStatus}'로 상태를 변경할까요?`
                            );
                            if (!proceed) return;
                        }
                    }

                    // 상태 업데이트 실행
                    const statusRef = ref(database, `orders/${orderId}/status`);
                    await set(statusRef, newStatus);

                    // 상태 업데이트 후 현재 필터 상태 유지
                    // 실시간 리스너가 자동으로 필터를 적용함
                } catch (err) {
                    console.error("상태 업데이트 오류:", err);
                    alert("상태 업데이트 중 오류가 발생했습니다.");
                }
            };

                         // 통계 업데이트 - 항상 전체 데이터를 기준으로 계산
             function updateStats(data) {
                 if (!data) {
                     document.getElementById("todayNewOrders").textContent = "0";
                     document.getElementById(
                         "todayExchangeRequests"
                     ).textContent = "0";
                     document.getElementById("todayReturnRequests").textContent =
                         "0";
                     document.getElementById("todayCancelRequests").textContent =
                         "0";
                     return;
                 }
 
                 const today = new Date();
                 today.setHours(0, 0, 0, 0);
                 const tomorrow = new Date(today);
                 tomorrow.setDate(tomorrow.getDate() + 1);
 
                 // 항상 전체 데이터를 기준으로 통계 계산
                 const entries = Object.entries(data);
                 
                 // 오늘 신규주문만 날짜 필터 적용
                 const todayOrders = entries.filter(([id, order]) => {
                     const orderDate = new Date(order.createdAt);
                     return orderDate >= today && orderDate < tomorrow;
                 });
 
                 // 주문 유형별 통계
                 const newOrders = todayOrders.filter(
                     ([id, order]) => order.orderType === "신규주문"
                 );
                 
                 // 전체 데이터에서 교환/반품/취소 진행중인 주문 카운트 (접수/배송중 상태)
                 // 이 부분은 항상 전체 데이터를 기준으로 계산하여 미처리 체크 개념 유지
                 const exchangeRequests = entries.filter(
                     ([id, order]) => 
                         order.orderType === "교환" && 
                         (order.status === "접수" || order.status === "배송중")
                 );
                 const returnRequests = entries.filter(
                     ([id, order]) => 
                         order.orderType === "반품" && 
                         (order.status === "접수" || order.status === "배송중")
                 );
                 const cancelRequests = entries.filter(
                     ([id, order]) => 
                         order.orderType === "취소" && 
                         (order.status === "접수" || order.status === "배송중")
                 );
 
                 document.getElementById("todayNewOrders").textContent =
                     newOrders.length;
                 document.getElementById("todayExchangeRequests").textContent =
                     exchangeRequests.length;
                 document.getElementById("todayReturnRequests").textContent =
                     returnRequests.length;
                 document.getElementById("todayCancelRequests").textContent =
                     cancelRequests.length;
             }

            // 최근 주문 업데이트
            // 최근주문 섹션 제거로 더미 함수 유지
            function updateRecentOrders(data) {
                /* no-op */
            }

            // 주문 필터링
            function filterOrdersData(entries) {
                const statusFilter =
                    document.getElementById("statusFilter").value;
                const orderTypeFilter =
                    document.getElementById("orderTypeFilter").value;
                const dateFilter = document.getElementById("dateFilter").value;
                const phoneSearch = document
                    .getElementById("phoneSearch")
                    .value.toLowerCase();
                const orderNumberSearch = document
                    .getElementById("orderNumberSearch")
                    .value.toLowerCase();

                return entries.filter(([id, order]) => {
                    // 휴대폰번호 검색
                    if (
                        phoneSearch &&
                        !order.phone.toLowerCase().includes(phoneSearch)
                    ) {
                        return false;
                    }

                    // 주문번호 검색
                    if (
                        orderNumberSearch &&
                        !order.orderNumber
                            .toLowerCase()
                            .includes(orderNumberSearch)
                    ) {
                        return false;
                    }

                    // 배송상태 필터
                    if (statusFilter && order.status !== statusFilter) {
                        return false;
                    }

                    // 주문유형 필터
                    if (
                        orderTypeFilter &&
                        order.orderType !== orderTypeFilter
                    ) {
                        return false;
                    }

                    // 날짜 필터
                    if (dateFilter) {
                        const orderDate = new Date(order.createdAt);
                        const now = new Date();

                        switch (dateFilter) {
                            case "recent3days":
                                const threeDaysAgo = new Date(now);
                                threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
                                return orderDate >= threeDaysAgo;
                                
                            case "today":
                                const today = new Date(now);
                                today.setHours(0, 0, 0, 0);
                                const tomorrow = new Date(today);
                                tomorrow.setDate(tomorrow.getDate() + 1);
                                return (
                                    orderDate >= today && orderDate < tomorrow
                                );

                            case "week":
                                const weekAgo = new Date(now);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                return orderDate >= weekAgo;
                        }
                    }

                    return true;
                });
            }

            // 필터 적용
            window.filterOrders = function () {
                const ordersRef = ref(database, "orders");
                const ordersQuery = query(ordersRef, orderByChild("createdAt"));
                onValue(
                    ordersQuery,
                    (snapshot) => {
                        const data = snapshot.val();
                        updateOrdersTable(data);
                        updateStats(data);
                        updateRecentOrders(data);
                    },
                    { onlyOnce: true }
                );
            };

            // 새로고침
            window.refreshOrders = function () {
                // 모든 필터를 기본값으로 설정
                document.getElementById("orderTypeFilter").value = ""; // 전체 주문유형
                document.getElementById("statusFilter").value = ""; // 전체 배송상태
                document.getElementById("dateFilter").value = "recent3days"; // 최근 3일
                document.getElementById("phoneSearch").value = ""; // 검색어 초기화
                document.getElementById("orderNumberSearch").value = ""; // 검색어 초기화

                // 주문 데이터 새로고침
                const ordersRef = ref(database, "orders");
                const ordersQuery = query(ordersRef, orderByChild("createdAt"));
                onValue(
                    ordersQuery,
                    (snapshot) => {
                        const data = snapshot.val();
                        updateOrdersTable(data);
                        updateStats(data);
                        updateRecentOrders(data);
                    },
                    { onlyOnce: true }
                );

                // 사용자에게 알림
                alert("새로고침 완료! 기본 필터가 적용되었습니다.");
            };

            // 신규주문 진행중 필터링
            window.filterNewOrdersInProgress = function () {
                // 필터 초기화
                document.getElementById("orderTypeFilter").value = "";
                document.getElementById("statusFilter").value = "";
                document.getElementById("dateFilter").value = "recent3days";
                document.getElementById("phoneSearch").value = "";
                document.getElementById("orderNumberSearch").value = "";

                // 필터 상태 저장
                currentFilterState = {
                    type: "newOrders",
                    filters: {
                        orderType: "신규주문",
                        status: ["접수", "배송중"],
                    },
                    searchTerms: {},
                };

                // JavaScript에서 직접 필터링
                filterNewOrdersInProgressCustom();

                // 사용자에게 알림
                alert("신규주문 중 접수/배송중 상태인 주문만 표시됩니다.");
            };

            // 교환/반품/취소 진행중 필터링
            window.filterExchangeReturnInProgress = function () {
                // 필터 초기화
                document.getElementById("dateFilter").value = "recent3days";
                document.getElementById("orderTypeFilter").value = "";
                document.getElementById("statusFilter").value = "";
                document.getElementById("phoneSearch").value = "";
                document.getElementById("orderNumberSearch").value = "";

                // 필터 상태 저장
                currentFilterState = {
                    type: "exchangeReturn",
                    filters: {
                        orderType: ["교환", "반품", "취소"],
                        status: ["접수", "배송중"],
                    },
                    searchTerms: {},
                };

                // JavaScript에서 직접 필터링
                filterExchangeReturnInProgressCustom();

                // 사용자에게 알림
                alert(
                    "교환/반품/취소 중 접수/배송중 상태인 주문만 표시됩니다."
                );
            };

            // 전체 보기 (모든 주문 표시)
            window.showAllOrders = function () {
                // 모든 필터 초기화
                document.getElementById("orderTypeFilter").value = "";
                document.getElementById("statusFilter").value = "";
                document.getElementById("dateFilter").value = "recent3days";
                document.getElementById("phoneSearch").value = "";
                document.getElementById("orderNumberSearch").value = "";

                // 필터 상태 저장
                currentFilterState = {
                    type: "all",
                    filters: {},
                    searchTerms: {},
                };

                // 전체 주문 데이터 다시 로드
                const ordersRef = ref(database, "orders");
                const ordersQuery = query(ordersRef, orderByChild("createdAt"));
                onValue(
                    ordersQuery,
                    (snapshot) => {
                        const data = snapshot.val();
                        updateOrdersTable(data);
                        updateStats(data);
                        updateRecentOrders(data);
                    },
                    { onlyOnce: true }
                );

                // 사용자에게 알림
                alert("전체 주문이 표시됩니다.");
            };

            // 전체 선택/해제
            window.toggleSelectAll = function () {
                const selectAll = document.getElementById("selectAll");
                const checkboxes = document.querySelectorAll(".order-checkbox");

                checkboxes.forEach((checkbox) => {
                    checkbox.checked = selectAll.checked;
                });

                updateBulkActions();
            };

            // 체크박스 선택 상태 변경 시 일괄 처리 도구 표시/숨김
            document.addEventListener("change", function (e) {
                if (e.target.classList.contains("order-checkbox")) {
                    updateBulkActions();
                }
            });

            // 일괄 처리 도구 업데이트
            function updateBulkActions() {
                const checkboxes = document.querySelectorAll(
                    ".order-checkbox:checked"
                );
                const bulkActions = document.querySelector(".bulk-actions");
                const selectedCount = document.getElementById("selectedCount");

                if (checkboxes.length > 0) {
                    bulkActions.style.display = "block";
                    selectedCount.textContent = `${checkboxes.length}개 선택됨`;
                } else {
                    bulkActions.style.display = "none";
                    selectAll.checked = false;
                }
            }

            // 신규주문 진행중 커스텀 필터링
            function filterNewOrdersInProgressCustom() {
                const ordersRef = ref(database, "orders");
                const ordersQuery = query(ordersRef, orderByChild("createdAt"));
                onValue(
                    ordersQuery,
                    (snapshot) => {
                        const data = snapshot.val();
                        if (!data) {
                            updateOrdersTable({});
                            return;
                        }

                        const entries = Object.entries(data);
                        console.log("전체 주문 데이터:", entries.length, "건");

                        const filteredEntries = entries.filter(
                            ([id, order]) => {
                                // 주문유형 필터 (신규주문만)
                                if (order.orderType !== "신규주문") {
                                    return false;
                                }

                                // 상태 필터 (접수 또는 배송중만)
                                if (
                                    order.status !== "접수" &&
                                    order.status !== "배송중"
                                ) {
                                    return false;
                                }

                                console.log(
                                    "신규주문 진행중 통과:",
                                    order.orderType,
                                    order.status,
                                    order.orderNumber
                                );
                                return true;
                            }
                        );

                        console.log(
                            "신규주문 진행중 필터링 결과:",
                            filteredEntries.length,
                            "건"
                        );

                        // 필터링된 데이터로 테이블 업데이트 (페이지네이션 적용)
                        const filteredData = {};
                        filteredEntries.forEach(([id, order]) => {
                            filteredData[id] = order;
                        });

                                                 // 페이지네이션 유지 및 테이블 업데이트
                         allFilteredData = Object.entries(filteredData);
                         updatePagination();
                         // 통계는 항상 전체 데이터로 업데이트 (미처리 체크 개념 유지)
                         updateStats(data);
                         updateRecentOrders(filteredData);
 
                         // 필터 상태 표시 업데이트
                         updateFilterStatusDisplay();
                     },
                     { onlyOnce: true }
                 );
             }
 
             // 교환/반품/취소 진행중 커스텀 필터링
             function filterExchangeReturnInProgressCustom() {
                const ordersRef = ref(database, "orders");
                const ordersQuery = query(ordersRef, orderByChild("createdAt"));
                onValue(
                    ordersQuery,
                    (snapshot) => {
                        const data = snapshot.val();
                        if (!data) {
                            updateOrdersTable({});
                            return;
                        }

                        const entries = Object.entries(data);
                        console.log("전체 주문 데이터:", entries.length, "건");

                        const filteredEntries = entries.filter(
                            ([id, order]) => {
                                // 주문유형 필터 (교환, 반품, 취소만)
                                if (
                                    order.orderType !== "교환" &&
                                    order.orderType !== "반품" &&
                                    order.orderType !== "취소"
                                ) {
                                    return false;
                                }

                                // 상태 필터 (접수 또는 배송중만)
                                if (
                                    order.status !== "접수" &&
                                    order.status !== "배송중"
                                ) {
                                    return false;
                                }

                                console.log(
                                    "교환/반품/취소 진행중 통과:",
                                    order.orderType,
                                    order.status,
                                    order.orderNumber
                                );
                                return true;
                            }
                        );

                        console.log(
                            "교환/반품/취소 진행중 필터링 결과:",
                            filteredEntries.length,
                            "건"
                        );

                        // 필터링된 데이터로 테이블 업데이트 (페이지네이션 적용)
                        const filteredData = {};
                        filteredEntries.forEach(([id, order]) => {
                            filteredData[id] = order;
                        });

                                                 // 페이지네이션 유지 및 테이블 업데이트
                         allFilteredData = Object.entries(filteredData);
                         updatePagination();
                         // 통계는 항상 전체 데이터로 업데이트 (미처리 체크 개념 유지)
                         updateStats(data);
                         updateRecentOrders(filteredData);
 
                         // 필터 상태 표시 업데이트
                         updateFilterStatusDisplay();
                     },
                     { onlyOnce: true }
                 );
             }

            // 커스텀 상태 필터링 (여러 상태 동시 지원)
            function filterOrdersWithCustomStatus(allowedStatuses) {
                const ordersRef = ref(database, "orders");
                const ordersQuery = query(ordersRef, orderByChild("createdAt"));
                onValue(
                    ordersQuery,
                    (snapshot) => {
                        const data = snapshot.val();
                        if (!data) {
                            updateOrdersTable({});
                            return;
                        }

                        const entries = Object.entries(data);
                        const filteredEntries = entries.filter(
                            ([id, order]) => {
                                // 주문유형 필터 (신규주문)
                                if (order.orderType !== "신규주문") {
                                    return false;
                                }

                                // 상태 필터 (접수 또는 배송중)
                                if (!allowedStatuses.includes(order.status)) {
                                    return false;
                                }

                                return true;
                            }
                        );

                                                 // 필터링된 데이터로 테이블 업데이트
                         const filteredData = {};
                         filteredEntries.forEach(([id, order]) => {
                             filteredData[id] = order;
                         });
 
                         updateOrdersTable(filteredData);
                         // 통계는 항상 전체 데이터로 업데이트 (미처리 체크 개념 유지)
                         updateStats(data);
                         updateRecentOrders(filteredData);
                     },
                     { onlyOnce: true }
                 );
             }
 
             // 커스텀 주문유형과 상태 필터링
             function filterOrdersWithCustomTypeAndStatus(
                allowedTypes,
                allowedStatuses
            ) {
                const ordersRef = ref(database, "orders");
                const ordersQuery = query(ordersRef, orderByChild("createdAt"));
                onValue(
                    ordersQuery,
                    (snapshot) => {
                        const data = snapshot.val();
                        if (!data) {
                            updateOrdersTable({});
                            return;
                        }

                        const entries = Object.entries(data);
                        console.log("전체 주문 데이터:", entries.length, "건");
                        console.log("허용된 주문유형:", allowedTypes);
                        console.log("허용된 상태:", allowedStatuses);

                        const filteredEntries = entries.filter(
                            ([id, order]) => {
                                // 주문유형 필터 (교환, 반품, 취소)
                                if (!allowedTypes.includes(order.orderType)) {
                                    console.log(
                                        "주문유형 필터링 제외:",
                                        order.orderType,
                                        order.orderNumber
                                    );
                                    return false;
                                }

                                // 상태 필터 (접수 또는 배송중)
                                if (!allowedStatuses.includes(order.status)) {
                                    console.log(
                                        "상태 필터링 제외:",
                                        order.status,
                                        order.orderNumber
                                    );
                                    return false;
                                }

                                console.log(
                                    "필터링 통과:",
                                    order.orderType,
                                    order.status,
                                    order.orderNumber
                                );
                                return true;
                            }
                        );

                        console.log(
                            "필터링 결과:",
                            filteredEntries.length,
                            "건"
                        );

                                                 // 필터링된 데이터로 테이블 업데이트
                         const filteredData = {};
                         filteredEntries.forEach(([id, order]) => {
                             filteredData[id] = order;
                         });
 
                         updateOrdersTable(filteredData);
                         // 통계는 항상 전체 데이터로 업데이트 (미처리 체크 개념 유지)
                         updateStats(data);
                         updateRecentOrders(filteredData);
                     },
                     { onlyOnce: true }
                 );
             }

            // 일괄 상태 업데이트
            window.bulkUpdateStatus = async function (newStatus) {
                const checkboxes = document.querySelectorAll(
                    ".order-checkbox:checked"
                );

                if (checkboxes.length === 0) {
                    alert("선택된 주문이 없습니다.");
                    return;
                }

                const confirmMessage = `선택된 ${checkboxes.length}개 주문의 상태를 '${newStatus}'로 변경하시겠습니까?`;
                if (!confirm(confirmMessage)) {
                    return;
                }

                // 모든 주문을 한 번만 로드
                const allSnap = await get(ref(database, `orders`));
                const all = allSnap.val() || {};

                // 선택된 주문들의 상세 수집
                const selectedOrders = [];
                for (const checkbox of checkboxes) {
                    const orderId = checkbox.value;
                    const order = all[orderId];
                    if (order) selectedOrders.push({ orderId, order });
                }

                // 클레임 감지 (배송중/배송완료 처리 시만 의미 있음)
                let claimAffected = [];
                if (newStatus === "배송중" || newStatus === "배송완료") {
                    claimAffected = selectedOrders.filter(({ order }) => {
                        return Object.values(all).some(
                            (o) =>
                                o &&
                                o.existingOrderNumber === order.orderNumber &&
                                (o.orderType === "교환" ||
                                    o.orderType === "반품" ||
                                    o.orderType === "취소") &&
                                (o.status === "접수" || o.status === "배송중")
                        );
                    });
                }

                if (claimAffected.length > 0) {
                    const sample = claimAffected
                        .slice(0, 5)
                        .map((v) => v.order.orderNumber)
                        .join(", ");
                    const proceed = confirm(
                        "새로운 클레임이 존재합니다.\n" +
                            "선택된 주문 중 일부는 교환/반품/취소 요청이 접수/진행 중이에요.\n" +
                            `해당 주문은 스킵하고 나머지만 '${newStatus}'로 변경할까요?` +
                            (sample
                                ? `\n예: ${sample}${
                                      claimAffected.length > 5 ? " 외" : ""
                                  }`
                                : "")
                    );
                    if (!proceed) return;
                }

                let successCount = 0;
                let skippedCount = 0;
                let errorCount = 0;

                for (const { orderId, order } of selectedOrders) {
                    // 클레임 영향 주문은 스킵
                    const isClaimed = claimAffected.some(
                        (v) => v.orderId === orderId
                    );
                    if (isClaimed) {
                        skippedCount++;
                        continue;
                    }
                    try {
                        const statusRef = ref(
                            database,
                            `orders/${orderId}/status`
                        );
                        await set(statusRef, newStatus);
                        successCount++;
                    } catch (error) {
                        console.error("상태 업데이트 오류:", error);
                        errorCount++;
                    }
                }

                // 체크박스 선택 해제
                checkboxes.forEach((checkbox) => (checkbox.checked = false));
                const selectAll = document.getElementById("selectAll");
                if (selectAll) selectAll.checked = false;
                updateBulkActions();

                // 결과 알림
                let message = `${successCount}개 상태 변경 완료`;
                if (skippedCount > 0)
                    message += `\n${skippedCount}개는 클레임 진행 중으로 스킵됨`;
                if (errorCount > 0) message += `\n${errorCount}개 실패`;
                alert(message);

                // 일괄 상태 업데이트 후 현재 필터 상태 유지
                // 실시간 리스너가 자동으로 필터를 적용함
            };

            // 7일이 지난 주문 자동 삭제
            async function deleteOldOrders(data) {
                if (!data) return;

                const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000; // 7일 전
                const entries = Object.entries(data);
                let deletedCount = 0;

                for (const [id, order] of entries) {
                    if (order.createdAt && order.createdAt < sevenDaysAgo) {
                        try {
                            const orderRef = ref(database, `orders/${id}`);
                            await set(orderRef, null); // 삭제
                            deletedCount++;
                        } catch (error) {
                            console.error("주문 삭제 오류:", error);
                        }
                    }
                }

                if (deletedCount > 0) {
                    console.log(
                        `${deletedCount}개의 오래된 주문이 삭제되었습니다.`
                    );
                }
            }

            // 영업일 계산 함수 (주말과 공휴일 제외)
            function isBusinessDay(date) {
                const day = date.getDay();
                // 주말 제외 (0: 일요일, 6: 토요일)
                if (day === 0 || day === 6) return false;

                // 한국 공휴일 체크 (주요 공휴일만)
                const month = date.getMonth() + 1;
                const dayOfMonth = date.getDate();

                // 신정, 설날, 삼일절, 어린이날, 부처님오신날, 현충일, 광복절, 개천절, 한글날, 성탄절
                const holidays = [
                    { month: 1, day: 1 }, // 신정
                    { month: 3, day: 1 }, // 삼일절
                    { month: 5, day: 5 }, // 어린이날
                    { month: 6, day: 6 }, // 현충일
                    { month: 8, day: 15 }, // 광복절
                    { month: 10, day: 3 }, // 개천절
                    { month: 10, day: 9 }, // 한글날
                    { month: 12, day: 25 }, // 성탄절
                ];

                // 설날과 추석은 음력이라 복잡하므로 간단히 처리 (추후 개선 가능)
                // 여기서는 주요 양력 공휴일만 체크

                return !holidays.some(
                    (holiday) =>
                        holiday.month === month && holiday.day === dayOfMonth
                );
            }

            // 영업일 기준으로 날짜 계산
            function addBusinessDays(startDate, businessDays) {
                let currentDate = new Date(startDate);
                let addedDays = 0;

                while (addedDays < businessDays) {
                    currentDate.setDate(currentDate.getDate() + 1);
                    if (isBusinessDay(currentDate)) {
                        addedDays++;
                    }
                }

                return currentDate;
            }

            // 3영업일이 지난 배송중 주문 자동 완료 처리
            async function autoCompleteShippedOrders(data) {
                if (!data) return;

                const now = new Date();
                let completedCount = 0;

                for (const [id, order] of Object.entries(data)) {
                    // 배송중 상태이고 배송 시작 시간이 있는 주문
                    if (order.status === "배송중" && order.shippingStartTime) {
                        const shippingStartDate = new Date(
                            order.shippingStartTime
                        );
                        const expectedCompletionDate = addBusinessDays(
                            shippingStartDate,
                            3
                        );

                        // 3영업일이 지났는지 확인
                        if (now >= expectedCompletionDate) {
                            try {
                                // 배송완료로 상태 변경
                                await set(
                                    ref(database, `orders/${id}/status`),
                                    "배송완료"
                                );
                                // 자동 완료 시간 기록
                                await set(
                                    ref(
                                        database,
                                        `orders/${id}/autoCompletedTime`
                                    ),
                                    Date.now()
                                );
                                completedCount++;

                                console.log(
                                    `주문 ${order.orderNumber}이(가) 3영업일 후 자동으로 배송완료 처리되었습니다.`
                                );
                            } catch (error) {
                                console.error(
                                    `자동 배송완료 처리 오류 (${id}):`,
                                    error
                                );
                            }
                        }
                    }
                }

                if (completedCount > 0) {
                    console.log(
                        `${completedCount}개의 배송중 주문이 3영업일 후 자동으로 배송완료 처리되었습니다.`
                    );
                }
            }

            // AI 제품 매칭용 Excel 내보내기 (배송상태까지)
            window.exportToExcelAI = function () {
                // 로딩 표시
                const exportBtn = document.querySelector(
                    'button[onclick="exportToExcelAI()"]'
                );
                const originalText = exportBtn.innerHTML;
                exportBtn.disabled = true;
                exportBtn.innerHTML =
                    '<svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> 처리중...';

                try {
                    // 필터링된 전체 데이터 사용 (페이지네이션 무관)
                    if (!allFilteredData || allFilteredData.length === 0) {
                        alert("내보낼 주문 데이터가 없습니다.");
                        return;
                    }

                    // 필터링된 전체 데이터 수집 (AI용 - 배송상태까지만)
                    const filteredData = [];
                    let processedCount = 0;
                    const totalCount = allFilteredData.length;

                    allFilteredData.forEach(([id, order]) => {
                        processedCount++;

                        // 1000건마다 진행률 업데이트
                        if (processedCount % 1000 === 0) {
                            const progress = Math.round(
                                (processedCount / totalCount) * 100
                            );
                            exportBtn.innerHTML = `<svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> ${progress}%`;
                        }

                        // 주문 데이터를 Excel 형식으로 변환 (AI용)
                        filteredData.push({
                            주문번호: order.orderNumber || "",
                            주문시간: order.createdAt
                                ? new Date(order.createdAt).toLocaleString(
                                      "ko-KR"
                                  )
                                : "",
                            입금자명: order.customerName || "",
                            연락처: order.phone || "",
                            주문유형: order.orderType || "신규주문",
                            기존주문번호: order.existingOrderNumber || "-",
                            구매제품: `${order.product || ""} (${
                                order.quantity || 0
                            }개)`,
                            주소: order.address || "",
                            상세주소: order.detailAddress || "",
                            배송메세지: `${order.memo || ""}${
                                order.refundAccount
                                    ? `\n\n환불 계좌정보:\n${order.refundAccount}`
                                    : ""
                            }`,
                            배송상태: order.status || "",
                        });
                    });

                    // 데이터 개수 확인
                    if (filteredData.length > 10000) {
                        const confirm = window.confirm(
                            `총 ${filteredData.length.toLocaleString()}건의 데이터를 내보냅니다.\n` +
                                `처리 시간이 오래 걸릴 수 있습니다.\n계속하시겠습니까?`
                        );
                        if (!confirm) {
                            return;
                        }
                    }

                    // Excel 파일 생성
                    const ws = XLSX.utils.json_to_sheet(filteredData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "주문목록_AI용");

                    const fileName = `주문목록_AI용_${
                        new Date().toISOString().split("T")[0]
                    }_${filteredData.length}건.xlsx`;
                    XLSX.writeFile(wb, fileName);

                    // 완료 메시지
                    alert(
                        `AI용 Excel 파일이 생성되었습니다.\n총 ${filteredData.length.toLocaleString()}건의 데이터가 포함되었습니다.`
                    );
                } catch (error) {
                    console.error("AI용 Excel 내보내기 오류:", error);
                    alert("AI용 Excel 내보내기 중 오류가 발생했습니다.");
                } finally {
                    // 버튼 복원
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = originalText;
                }
            };

            // 모든 정보 Excel 내보내기 (택배사/송장번호/작업까지 모두)
            window.exportToExcelFull = function () {
                // 로딩 표시
                const exportBtn = document.querySelector(
                    'button[onclick="exportToExcelFull()"]'
                );
                const originalText = exportBtn.innerHTML;
                exportBtn.disabled = true;
                exportBtn.innerHTML =
                    '<svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> 처리중...';

                try {
                    // 필터링된 전체 데이터 사용 (페이지네이션 무관)
                    if (!allFilteredData || allFilteredData.length === 0) {
                        alert("내보낼 주문 데이터가 없습니다.");
                        return;
                    }

                    // 필터링된 전체 데이터 수집 (전체 정보)
                    const filteredData = [];
                    let processedCount = 0;
                    const totalCount = allFilteredData.length;

                    allFilteredData.forEach(([id, order]) => {
                        processedCount++;

                        // 1000건마다 진행률 업데이트
                        if (processedCount % 1000 === 0) {
                            const progress = Math.round(
                                (processedCount / totalCount) * 100
                            );
                            exportBtn.innerHTML = `<svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> ${progress}%`;
                        }

                        // 주문 데이터를 Excel 형식으로 변환 (전체 정보)
                        filteredData.push({
                            주문번호: order.orderNumber || "",
                            주문시간: order.createdAt
                                ? new Date(order.createdAt).toLocaleString(
                                      "ko-KR"
                                  )
                                : "",
                            입금자명: order.customerName || "",
                            연락처: order.phone || "",
                            주문유형: order.orderType || "신규주문",
                            기존주문번호: order.existingOrderNumber || "-",
                            구매제품: `${order.product || ""} (${
                                order.quantity || 0
                            }개)`,
                            주소: order.address || "",
                            상세주소: order.detailAddress || "",
                            배송메세지: `${order.memo || ""}${
                                order.refundAccount
                                    ? `\n\n환불 계좌정보:\n${order.refundAccount}`
                                    : ""
                            }`,
                            배송상태: order.status || "",
                            택배사: order.courier || "-",
                            송장번호: order.invoiceNumber || "-",
                        });
                    });

                    // 데이터 개수 확인
                    if (filteredData.length > 10000) {
                        const confirm = window.confirm(
                            `총 ${filteredData.length.toLocaleString()}건의 데이터를 내보냅니다.\n` +
                                `처리 시간이 오래 걸릴 수 있습니다.\n계속하시겠습니까?`
                        );
                        if (!confirm) {
                            return;
                        }
                    }

                    // Excel 파일 생성
                    const ws = XLSX.utils.json_to_sheet(filteredData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "주문목록_전체");

                    const fileName = `주문목록_전체_${
                        new Date().toISOString().split("T")[0]
                    }_${filteredData.length}건.xlsx`;
                    XLSX.writeFile(wb, fileName);

                    // 완료 메시지
                    alert(
                        `전체 Excel 파일이 생성되었습니다.\n총 ${filteredData.length.toLocaleString()}건의 데이터가 포함되었습니다.`
                    );
                } catch (error) {
                    console.error("전체 Excel 내보내기 오류:", error);
                    alert("전체 Excel 내보내기 중 오류가 발생했습니다.");
                } finally {
                    // 버튼 복원
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = originalText;
                }
            };
        </script>
        </div> <!-- mainContent 닫기 -->
    </body>
</html>
