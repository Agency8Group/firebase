<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>0000ì…€ëŸ¬ ì£¼ë¬¸ ê´€ë¦¬ì í˜ì´ì§€</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            margin: 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        
        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .controls {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #1e7e34;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }
        
        .orders-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .section-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background-color: #f8f9fa;
        }
        
        .section-header h2 {
            margin: 0;
            color: #333;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .filter-select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .orders-table th {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .orders-table td {
            border: 1px solid #dee2e6;
            padding: 8px;
            vertical-align: top;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-ì ‘ìˆ˜ {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-ì¡°ë¦¬ì¤‘ {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-ë°°ì†¡ì¤‘ {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-ì™„ë£Œ {
            background-color: #c3e6cb;
            color: #155724;
        }
        
        .status-ì·¨ì†Œ {
            background-color: #f5c6cb;
            color: #721c24;
        }
        
        .status-select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .sidebar {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stats-card h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .stats-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stats-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .recent-orders {
            margin-top: 20px;
        }
        
        .recent-orders h3 {
            margin: 0 0 15px 0;
            color: #333;
        }
        
        .recent-order-item {
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }
        
        .recent-order-item h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: #333;
        }
        
        .recent-order-item p {
            margin: 0;
            font-size: 12px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”§ 0000ì…€ëŸ¬ ì£¼ë¬¸ ê´€ë¦¬ì</h1>
        <div class="status-bar">
            <div id="status" class="status disconnected">
                ğŸ”´ Firebase ì—°ê²° ì¤‘...
            </div>
            <div class="controls">
                <button class="btn btn-success" onclick="exportToExcel()">ğŸ“¥ Excel ë‚´ë³´ë‚´ê¸°</button>
                <button class="btn btn-primary" onclick="refreshOrders()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="orders-section">
            <div class="section-header">
                <h2>ğŸ“‹ ì£¼ë¬¸ ëª©ë¡</h2>
                <div class="filters">
                    <select id="statusFilter" class="filter-select" onchange="filterOrders()">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="ì ‘ìˆ˜">ì ‘ìˆ˜</option>
                        <option value="ì¡°ë¦¬ì¤‘">ì¡°ë¦¬ì¤‘</option>
                        <option value="ë°°ì†¡ì¤‘">ë°°ì†¡ì¤‘</option>
                        <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                        <option value="ì·¨ì†Œ">ì·¨ì†Œ</option>
                    </select>
                    <select id="dateFilter" class="filter-select" onchange="filterOrders()">
                        <option value="">ì „ì²´ ê¸°ê°„</option>
                        <option value="today">ì˜¤ëŠ˜</option>
                        <option value="week">ì´ë²ˆ ì£¼</option>
                        <option value="month">ì´ë²ˆ ë‹¬</option>
                    </select>
                </div>
            </div>
            
            <div class="table-container">
                <table class="orders-table" id="ordersTable">
                    <thead>
                        <tr>
                            <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                            <th>ê³ ê°ëª…</th>
                            <th>ì—°ë½ì²˜</th>
                            <th>ìƒí’ˆëª…</th>
                            <th>ìˆ˜ëŸ‰</th>
                            <th>ì£¼ì†Œ</th>
                            <th>ìƒíƒœ</th>
                            <th>ì ‘ìˆ˜ì¼ì‹œ</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <!-- ì£¼ë¬¸ ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="sidebar">
            <div class="stats-card">
                <h3>ğŸ“Š ì˜¤ëŠ˜ì˜ í†µê³„</h3>
                <div class="stats-number" id="todayOrders">0</div>
                <div class="stats-label">ì£¼ë¬¸ ê±´ìˆ˜</div>
            </div>
            
            <div class="stats-card">
                <h3>ğŸ’° ë§¤ì¶œ í˜„í™©</h3>
                <div class="stats-number" id="todayRevenue">0ì›</div>
                <div class="stats-label">ì˜ˆìƒ ë§¤ì¶œ</div>
            </div>
            
            <div class="recent-orders">
                <h3>ğŸ†• ìµœê·¼ ì£¼ë¬¸</h3>
                <div id="recentOrdersList">
                    <!-- ìµœê·¼ ì£¼ë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, query, orderByChild } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA3og6X2bk2Tb2cvs9wiTm_HqdqdlIuTt8",
            authDomain: "main-project-5d624.firebaseapp.com",
            projectId: "main-project-5d624",
            storageBucket: "main-project-5d624.firebasestorage.app",
            messagingSenderId: "232188977313",
            appId: "1:232188977313:web:247a5557753a2ead6750e0",
            measurementId: "G-BWVCXZMY53",
            databaseURL: "https://main-project-5d624-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // DOM ìš”ì†Œë“¤
        const statusDiv = document.getElementById('status');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const todayOrdersSpan = document.getElementById('todayOrders');
        const todayRevenueSpan = document.getElementById('todayRevenue');
        const recentOrdersList = document.getElementById('recentOrdersList');

        // ì—°ê²° ìƒíƒœ í™•ì¸
        const connectedRef = ref(database, ".info/connected");
        onValue(connectedRef, (snap) => {
            if (snap.val() === true) {
                statusDiv.textContent = "ğŸŸ¢ Firebase ì—°ê²°ë¨ - ì‹¤ì‹œê°„ ì£¼ë¬¸ ê´€ë¦¬ ì¤‘!";
                statusDiv.className = "status connected";
            } else {
                statusDiv.textContent = "ğŸ”´ Firebase ì—°ê²° ëŠê¹€";
                statusDiv.className = "status disconnected";
            }
        });

        // ì‹¤ì‹œê°„ ì£¼ë¬¸ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ
        const ordersRef = ref(database, 'orders');
        const ordersQuery = query(ordersRef, orderByChild('createdAt'));
        onValue(ordersQuery, (snapshot) => {
            const data = snapshot.val();
            updateOrdersTable(data);
            updateStats(data);
            updateRecentOrders(data);
        });

        // ì£¼ë¬¸ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateOrdersTable(data) {
            ordersTableBody.innerHTML = '';
            
            if (!data) {
                ordersTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            const entries = Object.entries(data);
            const filteredEntries = filterOrdersData(entries);
            
            if (filteredEntries.length === 0) {
                ordersTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">í•„í„°ë§ëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            // ìµœì‹  ì£¼ë¬¸ë¶€í„° í‘œì‹œ
            filteredEntries.reverse().forEach(([id, order]) => {
                const row = createOrderRow(id, order);
                ordersTableBody.appendChild(row);
            });
        }

        // ì£¼ë¬¸ í–‰ ìƒì„±
        function createOrderRow(id, order) {
            const row = document.createElement('tr');
            const orderDate = new Date(order.createdAt);
            const fullAddress = [order.address, order.detailAddress].filter(Boolean).join(' ');
            
            row.innerHTML = `
                <td><strong>${order.orderNumber}</strong></td>
                <td>${order.customerName}</td>
                <td>${order.phone}</td>
                <td>${order.product}</td>
                <td>${order.quantity}ê°œ</td>
                <td style="max-width: 200px; word-break: break-all;">${fullAddress}</td>
                <td>
                    <span class="status-badge status-${order.status}">${order.status}</span>
                </td>
                <td>${orderDate.toLocaleString('ko-KR')}</td>
                <td>
                    <select class="status-select" onchange="updateOrderStatus('${id}', this.value)">
                        <option value="ì ‘ìˆ˜" ${order.status === 'ì ‘ìˆ˜' ? 'selected' : ''}>ì ‘ìˆ˜</option>
                        <option value="ì¡°ë¦¬ì¤‘" ${order.status === 'ì¡°ë¦¬ì¤‘' ? 'selected' : ''}>ì¡°ë¦¬ì¤‘</option>
                        <option value="ë°°ì†¡ì¤‘" ${order.status === 'ë°°ì†¡ì¤‘' ? 'selected' : ''}>ë°°ì†¡ì¤‘</option>
                        <option value="ì™„ë£Œ" ${order.status === 'ì™„ë£Œ' ? 'selected' : ''}>ì™„ë£Œ</option>
                        <option value="ì·¨ì†Œ" ${order.status === 'ì·¨ì†Œ' ? 'selected' : ''}>ì·¨ì†Œ</option>
                    </select>
                </td>
            `;

            return row;
        }

        // ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸
        window.updateOrderStatus = function(orderId, newStatus) {
            const orderRef = ref(database, `orders/${orderId}/status`);
            set(orderRef, newStatus);
        };

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(data) {
            if (!data) {
                todayOrdersSpan.textContent = '0';
                todayRevenueSpan.textContent = '0ì›';
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const entries = Object.entries(data);
            const todayOrders = entries.filter(([id, order]) => {
                const orderDate = new Date(order.createdAt);
                return orderDate >= today && orderDate < tomorrow;
            });

            todayOrdersSpan.textContent = todayOrders.length;
            
            // ì˜ˆìƒ ë§¤ì¶œ ê³„ì‚° (ìƒí’ˆë‹¹ 10,000ì› ê°€ì •)
            const totalRevenue = todayOrders.reduce((sum, [id, order]) => {
                return sum + (order.quantity * 10000);
            }, 0);
            
            todayRevenueSpan.textContent = totalRevenue.toLocaleString() + 'ì›';
        }

        // ìµœê·¼ ì£¼ë¬¸ ì—…ë°ì´íŠ¸
        function updateRecentOrders(data) {
            if (!data) {
                recentOrdersList.innerHTML = '<p style="color: #666; font-size: 12px;">ìµœê·¼ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const entries = Object.entries(data);
            const recentOrders = entries.slice(-5).reverse(); // ìµœê·¼ 5ê°œ

            recentOrdersList.innerHTML = '';
            recentOrders.forEach(([id, order]) => {
                const orderDate = new Date(order.createdAt);
                const item = document.createElement('div');
                item.className = 'recent-order-item';
                item.innerHTML = `
                    <h4>${order.customerName} - ${order.product}</h4>
                    <p>${orderDate.toLocaleString('ko-KR')} | ${order.status}</p>
                `;
                recentOrdersList.appendChild(item);
            });
        }

        // ì£¼ë¬¸ í•„í„°ë§
        function filterOrdersData(entries) {
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            return entries.filter(([id, order]) => {
                // ìƒíƒœ í•„í„°
                if (statusFilter && order.status !== statusFilter) {
                    return false;
                }

                // ë‚ ì§œ í•„í„°
                if (dateFilter) {
                    const orderDate = new Date(order.createdAt);
                    const now = new Date();
                    
                    switch (dateFilter) {
                        case 'today':
                            const today = new Date(now);
                            today.setHours(0, 0, 0, 0);
                            const tomorrow = new Date(today);
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            return orderDate >= today && orderDate < tomorrow;
                        
                        case 'week':
                            const weekAgo = new Date(now);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            return orderDate >= weekAgo;
                        
                        case 'month':
                            const monthAgo = new Date(now);
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            return orderDate >= monthAgo;
                    }
                }

                return true;
            });
        }

        // í•„í„° ì ìš©
        window.filterOrders = function() {
            const ordersRef = ref(database, 'orders');
            const ordersQuery = query(ordersRef, orderByChild('createdAt'));
            onValue(ordersQuery, (snapshot) => {
                const data = snapshot.val();
                updateOrdersTable(data);
            });
        };

        // ìƒˆë¡œê³ ì¹¨
        window.refreshOrders = function() {
            const ordersRef = ref(database, 'orders');
            const ordersQuery = query(ordersRef, orderByChild('createdAt'));
            onValue(ordersQuery, (snapshot) => {
                const data = snapshot.val();
                updateOrdersTable(data);
                updateStats(data);
                updateRecentOrders(data);
            });
        };

        // Excel ë‚´ë³´ë‚´ê¸°
        window.exportToExcel = function() {
            const ordersRef = ref(database, 'orders');
            onValue(ordersRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    alert('ë‚´ë³´ë‚¼ ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const entries = Object.entries(data);
                const excelData = entries.map(([id, order]) => ({
                    'ì£¼ë¬¸ë²ˆí˜¸': order.orderNumber,
                    'ê³ ê°ëª…': order.customerName,
                    'ì—°ë½ì²˜': order.phone,
                    'ìƒí’ˆëª…': order.product,
                    'ìˆ˜ëŸ‰': order.quantity,
                    'ì£¼ì†Œ': [order.address, order.detailAddress].filter(Boolean).join(' '),
                    'ìƒíƒœ': order.status,
                    'ë©”ëª¨': order.memo || '',
                    'ì ‘ìˆ˜ì¼ì‹œ': new Date(order.createdAt).toLocaleString('ko-KR')
                }));

                const ws = XLSX.utils.json_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ì£¼ë¬¸ëª©ë¡");
                
                const fileName = `ì£¼ë¬¸ëª©ë¡_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
            }, { onlyOnce: true });
        };
    </script>
</body>
</html>

