<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>0000셀러 주문 관리자 페이지</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <style>
            * {
                box-sizing: border-box;
            }

            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 20px;
                background-color: #f8f9fa;
                line-height: 1.45;
                -webkit-text-size-adjust: 100%;
            }

            .header {
                background: white;
                padding: 28px;
                border-radius: 16px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
                margin-bottom: 24px;
                border: 1px solid #f1f3f4;
            }

            .header h1 {
                margin: 0 0 20px 0;
                color: #212529;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 24px;
                font-weight: 600;
            }

            .header-stats {
                display: flex;
                gap: 32px;
                margin-bottom: 20px;
                padding: 20px;
                background: #f8f9fa;
                border: 1px solid #e9ecef;
                border-radius: 12px;
                color: #333;
            }

            .stats-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
                flex: 1;
            }

            .stats-item .stats-label {
                font-size: 13px;
                color: #6c757d;
                margin-bottom: 6px;
                font-weight: 500;
            }

            .stats-item .stats-number {
                font-size: 24px;
                font-weight: 700;
                color: #212529;
            }

            .status-bar {
                display: flex;
                justify-content: flex-end;
                align-items: center;
            }

            .status-indicator {
                display: inline-block;
                width: 16px;
                height: 16px;
                border-radius: 50%;
                margin-left: 12px;
                vertical-align: middle;
                border: 2px solid #ddd;
            }

            .status-indicator.connected {
                background-color: #28a745;
            }

            .status-indicator.disconnected {
                background-color: #dc3545;
            }

            .controls {
                display: flex;
                gap: 10px;
            }

            .btn {
                padding: 12px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                min-height: 44px;
                transition: all 0.2s ease;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
                font-weight: 500;
            }

            .btn-primary {
                background-color: #007bff;
                color: white;
            }

            .btn-primary:hover {
                background-color: #0056b3;
                transform: translateY(-1px);
            }

            .btn-success {
                background-color: #28a745;
                color: white;
            }

            .btn-success:hover {
                background-color: #1e7e34;
                transform: translateY(-1px);
            }

            .btn-warning {
                background-color: #ffc107;
                color: #212529;
            }

            .btn-warning:hover {
                background-color: #e0a800;
                transform: translateY(-1px);
            }

            .main-content {
                display: grid;
                grid-template-columns: 1fr 300px;
                gap: 20px;
            }

            .orders-section {
                background: white;
                border-radius: 16px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
                overflow: hidden;
                border: 1px solid #f1f3f4;
            }

            .section-header {
                padding: 24px;
                border-bottom: 1px solid #f1f3f4;
                background-color: #fafbfc;
            }

            .section-header h2 {
                margin: 0;
                color: #212529;
                font-size: 18px;
                font-weight: 600;
            }

            .filters {
                display: flex;
                flex-direction: column;
                gap: 12px;
                margin-top: 10px;
            }

            .search-fields {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            .search-input {
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
                min-width: 200px;
                flex: 1;
            }

            .search-input:focus {
                outline: none;
                border-color: #007bff;
                box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
            }

            .filter-selects {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            .filter-select {
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
            }

            .table-container {
                overflow-x: auto;
                max-height: 600px;
                overflow-y: auto;
            }

            .orders-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 14px;
            }

            .orders-table th {
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                padding: 12px 8px;
                text-align: left;
                font-weight: 600;
                color: #495057;
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .orders-table td {
                border: 1px solid #dee2e6;
                padding: 8px;
                vertical-align: top;
            }

            .status-badge {
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 500;
            }

            .status-접수 {
                background-color: #fff3cd;
                color: #856404;
            }

            .status-배송중 {
                background-color: #d1ecf1;
                color: #0c5460;
            }



            .status-배송완료 {
                background-color: #d4edda;
                color: #155724;
            }

            .status-취소 {
                background-color: #f5c6cb;
                color: #721c24;
            }

            .order-type-badge {
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 500;
                background-color: #e3f2fd;
                color: #1976d2;
            }

            .status-select {
                padding: 4px 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 12px;
            }

            .sidebar {
                background: white;
                border-radius: 16px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
                padding: 24px;
                border: 1px solid #f1f3f4;
            }



            .recent-orders {
                margin-top: 20px;
            }

            .recent-orders h3 {
                margin: 0 0 16px 0;
                color: #212529;
                font-size: 16px;
                font-weight: 600;
            }

            .recent-order-item {
                padding: 12px;
                border: 1px solid #f1f3f4;
                border-radius: 8px;
                margin-bottom: 12px;
                background-color: #fafbfc;
                transition: all 0.2s ease;
            }

            .recent-order-item:hover {
                border-color: #e1e5e9;
                background-color: #f8f9fa;
            }

            /* SVG Icon Styles */
            .inline-icon {
                width: 18px;
                height: 18px;
                vertical-align: middle;
                margin-right: 6px;
            }

            .recent-order-item h4 {
                margin: 0 0 5px 0;
                font-size: 14px;
                color: #333;
            }

            .recent-order-item p {
                margin: 0;
                font-size: 12px;
                color: #666;
            }

            /* 자동 삭제 경고 스타일 */
            .auto-delete-warning {
                display: flex;
                align-items: center;
                gap: 8px;
                background-color: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 8px;
                padding: 12px 16px;
                margin-top: 12px;
                color: #856404;
                font-size: 14px;
                line-height: 1.4;
            }

            .auto-delete-warning .inline-icon {
                flex-shrink: 0;
                width: 20px;
                height: 20px;
            }

            .auto-delete-warning span {
                flex: 1;
            }

            /* 일괄 처리 도구 스타일 */
            .bulk-actions {
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 16px;
                margin-bottom: 16px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 12px;
            }

            .bulk-actions-info {
                font-weight: 600;
                color: #495057;
            }

            .bulk-actions-buttons {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }

            .btn-sm {
                padding: 8px 12px;
                font-size: 12px;
                min-height: 36px;
            }

            /* 체크박스 스타일 */
            .order-checkbox {
                width: 16px;
                height: 16px;
                cursor: pointer;
            }

            #selectAll {
                width: 16px;
                height: 16px;
                cursor: pointer;
            }

            @media (max-width: 768px) {
                body {
                    padding: 8px;
                    font-size: 13px;
                }
                
                .header {
                    padding: 12px;
                    border-radius: 12px;
                }
                
                .header h1 {
                    font-size: 20px;
                    margin-bottom: 16px;
                }
                
                .header-stats {
                    flex-direction: column;
                    gap: 10px;
                    padding: 12px;
                }
                
                .stats-item {
                    flex-direction: row;
                    justify-content: space-between;
                    width: 100%;
                }
                
                .stats-item .stats-number {
                    font-size: 16px;
                }
                
                .stats-item .stats-label {
                    font-size: 11px;
                }
                
                .main-content {
                    grid-template-columns: 1fr;
                    gap: 12px;
                }

                .filters {
                    flex-direction: column;
                    gap: 8px;
                }
                
                .search-fields {
                    flex-direction: column;
                    gap: 8px;
                }
                
                .search-input {
                    min-width: auto;
                    width: 100%;
                }
                
                .filter-selects {
                    flex-direction: column;
                    gap: 8px;
                }

                .controls {
                    flex-direction: column;
                    gap: 8px;
                }
                
                .orders-table {
                    font-size: 11px;
                }
                
                .orders-table th,
                .orders-table td {
                    padding: 4px 2px;
                }
                
                .btn {
                    padding: 8px 12px;
                    min-height: 40px;
                    font-size: 13px;
                }
            }

            /* Simple Footer */
            .simple-footer {
                margin-top: 40px;
                padding: 20px 0;
                text-align: center;
                border-top: 1px solid #e9ecef;
            }

            .simple-footer a {
                color: #6c757d;
                text-decoration: none;
                font-size: 12px;
                transition: color 0.2s ease;
            }

            .simple-footer a:hover {
                color: #495057;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1><svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> 0000셀러 주문 접수 관리자<span id="status" class="status-indicator disconnected"></span></h1>
            <div class="header-stats">
                <div class="stats-item">
                    <span class="stats-label">오늘 신규주문</span>
                    <span class="stats-number" id="todayNewOrders">0</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">교환접수요청</span>
                    <span class="stats-number" id="todayExchangeRequests">0</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">반품접수요청</span>
                    <span class="stats-number" id="todayReturnRequests">0</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">취소요청</span>
                    <span class="stats-number" id="todayCancelRequests">0</span>
                </div>
            </div>
            <div class="status-bar">
                <div class="controls">
                    <button class="btn btn-warning" onclick="filterNewOrdersInProgress()">
                        <svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> 신규주문 진행중
                    </button>
                    <button class="btn btn-info" onclick="filterExchangeReturnInProgress()">
                        <svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg> 교환/반품/취소 진행중
                    </button>
                    <button class="btn btn-success" onclick="exportToExcel()">
                        <svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> Excel 내보내기
                    </button>
                    <button class="btn btn-primary" onclick="refreshOrders()">
                        <svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg> 새로고침
                    </button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="orders-section">
                <div class="section-header">
                    <h2><svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg> 주문 목록</h2>
                    <div class="auto-delete-warning">
                        <svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor" style="color: #dc3545;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                        <span>⚠️ 주문 데이터는 7일이 지나면 자동으로 삭제됩니다. 중요한 데이터는 Excel로 다운로드하여 백업하세요.</span>
                    </div>
                    <div class="filters">
                        <div class="search-fields">
                            <input
                                type="text"
                                id="phoneSearch"
                                class="search-input"
                                placeholder="휴대폰번호 검색"
                                onkeyup="filterOrders()"
                            />
                            <input
                                type="text"
                                id="orderNumberSearch"
                                class="search-input"
                                placeholder="주문번호 검색"
                                onkeyup="filterOrders()"
                            />
                        </div>
                        <div class="filter-selects">
                            <select
                                id="orderTypeFilter"
                                class="filter-select"
                                onchange="filterOrders()"
                            >
                                <option value="">전체 주문유형</option>
                                <option value="신규주문">신규주문</option>
                                <option value="교환">교환</option>
                                <option value="반품">반품</option>
                                <option value="취소">취소</option>
                            </select>
                            <select
                                id="statusFilter"
                                class="filter-select"
                                onchange="filterOrders()"
                            >
                                <option value="">전체 배송상태</option>
                                <option value="접수">접수</option>
                                <option value="배송중">배송중</option>
                                <option value="배송완료">배송완료</option>
                                <option value="취소">취소</option>
                            </select>
                            <select
                                id="dateFilter"
                                class="filter-select"
                                onchange="filterOrders()"
                            >
                                <option value="">전체 기간</option>
                                <option value="today" selected>오늘</option>
                                <option value="week">이번 주</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <!-- 일괄 처리 도구 -->
                    <div class="bulk-actions" style="display: none;">
                        <div class="bulk-actions-info">
                            <span id="selectedCount">0개 선택됨</span>
                        </div>
                        <div class="bulk-actions-buttons">
                            <button class="btn btn-success btn-sm" onclick="bulkUpdateStatus('배송완료')">
                                <svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> 선택된 주문 배송완료
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="bulkUpdateStatus('배송중')">
                                <svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> 선택된 주문 배송중
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="bulkUpdateStatus('취소')">
                                <svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> 선택된 주문 취소
                            </button>
                        </div>
                    </div>
                    
                    <table class="orders-table" id="ordersTable">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" title="전체 선택">
                                </th>
                                <th>주문번호</th>
                                <th>주문시간</th>
                                <th>입금자명</th>
                                <th>연락처</th>
                                <th>주문유형</th>
                                <th>기존주문번호</th>
                                <th>구매제품</th>
                                <th>주소</th>
                                <th>상세주소</th>
                                <th>배송메세지</th>
                                <th>배송상태</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- 주문 데이터가 여기에 동적으로 추가됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="sidebar">
                <div class="recent-orders">
                    <h3><svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg> 최근 주문</h3>
                    <div id="recentOrdersList">
                        <!-- 최근 주문이 여기에 표시됩니다 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Simple Footer -->
        <footer class="simple-footer">
            <a href="https://cx-tech-builder.netlify.app/" target="_blank">
                Powered by CX Tech Builder
            </a>
        </footer>

        <!-- Firebase SDK -->
        <script type="module">
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
            import {
                getDatabase,
                ref,
                onValue,
                set,
                query,
                orderByChild,
            } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

            // Your web app's Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyA4Z1B42fmBIJznBED11XIIiVVKN5OSQ1E",
                authDomain: "seller1-b8a4c.firebaseapp.com",
                projectId: "seller1-b8a4c",
                storageBucket: "seller1-b8a4c.firebasestorage.app",
                messagingSenderId: "740000823974",
                appId: "1:740000823974:web:ac62ca392ffb34e96e9267",
                measurementId: "G-Q8ZNT6PDB9",
                databaseURL: "https://seller1-b8a4c-default-rtdb.asia-southeast1.firebasedatabase.app"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const database = getDatabase(app);

            // DOM 요소들
            const statusDiv = document.getElementById("status");
            const ordersTableBody = document.getElementById("ordersTableBody");
            const recentOrdersList = document.getElementById("recentOrdersList");

            // 연결 상태 확인
            const connectedRef = ref(database, ".info/connected");
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    statusDiv.className = "status-indicator connected";
                } else {
                    statusDiv.className = "status-indicator disconnected";
                }
            });

            // 실시간 주문 데이터 리스너
            const ordersRef = ref(database, "orders");
            const ordersQuery = query(ordersRef, orderByChild("createdAt"));
            onValue(ordersQuery, (snapshot) => {
                const data = snapshot.val();
                updateOrdersTable(data);
                updateStats(data);
                updateRecentOrders(data);
                
                // 7일이 지난 주문 자동 삭제
                deleteOldOrders(data);
            });

            // 주문 테이블 업데이트
            function updateOrdersTable(data) {
                ordersTableBody.innerHTML = "";

                if (!data) {
                    ordersTableBody.innerHTML =
                        '<tr><td colspan="10" style="text-align: center; padding: 20px;">주문이 없습니다.</td></tr>';
                    return;
                }

                const entries = Object.entries(data);
                const filteredEntries = filterOrdersData(entries);

                if (filteredEntries.length === 0) {
                    ordersTableBody.innerHTML =
                        '<tr><td colspan="10" style="text-align: center; padding: 20px;">필터링된 주문이 없습니다.</td></tr>';
                    return;
                }

                // 최신 주문부터 표시
                filteredEntries.reverse().forEach(([id, order]) => {
                    const row = createOrderRow(id, order);
                    ordersTableBody.appendChild(row);
                });
            }



            // 주문 행 생성
            function createOrderRow(id, order) {
                const row = document.createElement("tr");
                const orderDate = new Date(order.createdAt);

                row.innerHTML = `
                <td>
                    <input type="checkbox" class="order-checkbox" value="${id}" data-status="${order.status}">
                </td>
                <td><strong>${order.orderNumber}</strong></td>
                <td>${orderDate.toLocaleString("ko-KR")}</td>
                <td>${order.customerName}</td>
                <td>${order.phone}</td>
                <td><span class="order-type-badge">${order.orderType || '신규주문'}</span></td>
                <td>${order.existingOrderNumber || '-'}</td>
                <td>${order.product} (${order.quantity}개)</td>
                <td style="max-width: 150px; word-break: break-all;">${
                    order.address || ""
                }</td>
                <td style="max-width: 150px; word-break: break-all;">${
                    order.detailAddress || ""
                }</td>
                <td style="max-width: 150px; word-break: break-all;">${
                    order.memo || ""
                }</td>
                <td>
                    <span class="status-badge status-${order.status}">${
                    order.status
                }</span>
                </td>
                <td>
                    <select class="status-select" onchange="updateOrderStatus('${id}', this.value)">
                        <option value="접수" ${
                            order.status === "접수" ? "selected" : ""
                        }>접수</option>
                        <option value="배송중" ${
                            order.status === "배송중" ? "selected" : ""
                        }>배송중</option>
                        <option value="배송완료" ${
                            order.status === "배송완료" ? "selected" : ""
                        }>배송완료</option>
                        <option value="취소" ${
                            order.status === "취소" ? "selected" : ""
                        }>취소</option>
                    </select>
                </td>
            `;

                return row;
            }

            // 주문 상태 업데이트
            window.updateOrderStatus = function (orderId, newStatus) {
                const orderRef = ref(database, `orders/${orderId}/status`);
                set(orderRef, newStatus);
            };

            // 통계 업데이트
            function updateStats(data) {
                if (!data) {
                    document.getElementById('todayNewOrders').textContent = "0";
                    document.getElementById('todayExchangeRequests').textContent = "0";
                    document.getElementById('todayReturnRequests').textContent = "0";
                    document.getElementById('todayCancelRequests').textContent = "0";
                    return;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);

                const entries = Object.entries(data);
                const todayOrders = entries.filter(([id, order]) => {
                    const orderDate = new Date(order.createdAt);
                    return orderDate >= today && orderDate < tomorrow;
                });

                // 주문 유형별 통계
                const newOrders = todayOrders.filter(([id, order]) => order.orderType === '신규주문');
                const exchangeRequests = todayOrders.filter(([id, order]) => order.orderType === '교환');
                const returnRequests = todayOrders.filter(([id, order]) => order.orderType === '반품');
                const cancelRequests = todayOrders.filter(([id, order]) => order.orderType === '취소');

                document.getElementById('todayNewOrders').textContent = newOrders.length;
                document.getElementById('todayExchangeRequests').textContent = exchangeRequests.length;
                document.getElementById('todayReturnRequests').textContent = returnRequests.length;
                document.getElementById('todayCancelRequests').textContent = cancelRequests.length;
            }

            // 최근 주문 업데이트
            function updateRecentOrders(data) {
                if (!data) {
                    recentOrdersList.innerHTML =
                        '<p style="color: #666; font-size: 12px;">최근 주문이 없습니다.</p>';
                    return;
                }

                const entries = Object.entries(data);
                const recentOrders = entries.slice(-5).reverse(); // 최근 5개

                recentOrdersList.innerHTML = "";
                recentOrders.forEach(([id, order]) => {
                    const orderDate = new Date(order.createdAt);
                    const item = document.createElement("div");
                    item.className = "recent-order-item";
                    item.innerHTML = `
                    <h4>${order.customerName} - ${order.product}</h4>
                    <p>${orderDate.toLocaleString("ko-KR")} | ${
                        order.status
                    }</p>
                `;
                    recentOrdersList.appendChild(item);
                });
            }

            // 주문 필터링
            function filterOrdersData(entries) {
                const statusFilter = document.getElementById("statusFilter").value;
                const orderTypeFilter = document.getElementById("orderTypeFilter").value;
                const dateFilter = document.getElementById("dateFilter").value;
                const phoneSearch = document.getElementById("phoneSearch").value.toLowerCase();
                const orderNumberSearch = document.getElementById("orderNumberSearch").value.toLowerCase();

                return entries.filter(([id, order]) => {
                    // 휴대폰번호 검색
                    if (phoneSearch && !order.phone.toLowerCase().includes(phoneSearch)) {
                        return false;
                    }

                    // 주문번호 검색
                    if (orderNumberSearch && !order.orderNumber.toLowerCase().includes(orderNumberSearch)) {
                        return false;
                    }

                    // 배송상태 필터
                    if (statusFilter && order.status !== statusFilter) {
                        return false;
                    }

                    // 주문유형 필터
                    if (orderTypeFilter && order.orderType !== orderTypeFilter) {
                        return false;
                    }

                    // 날짜 필터
                    if (dateFilter) {
                        const orderDate = new Date(order.createdAt);
                        const now = new Date();

                        switch (dateFilter) {
                            case "today":
                                const today = new Date(now);
                                today.setHours(0, 0, 0, 0);
                                const tomorrow = new Date(today);
                                tomorrow.setDate(tomorrow.getDate() + 1);
                                return (
                                    orderDate >= today && orderDate < tomorrow
                                );

                            case "week":
                                const weekAgo = new Date(now);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                return orderDate >= weekAgo;
                        }
                    }

                    return true;
                });
            }

            // 필터 적용
            window.filterOrders = function () {
                const ordersRef = ref(database, "orders");
                const ordersQuery = query(ordersRef, orderByChild("createdAt"));
                onValue(ordersQuery, (snapshot) => {
                    const data = snapshot.val();
                    updateOrdersTable(data);
                });
            };

            // 새로고침
            window.refreshOrders = function () {
                const ordersRef = ref(database, "orders");
                const ordersQuery = query(ordersRef, orderByChild("createdAt"));
                onValue(ordersQuery, (snapshot) => {
                    const data = snapshot.val();
                    updateOrdersTable(data);
                    updateStats(data);
                    updateRecentOrders(data);
                });
            };

            // 신규주문 진행중 필터링
            window.filterNewOrdersInProgress = function() {
                // 필터 초기화
                document.getElementById('orderTypeFilter').value = '신규주문';
                document.getElementById('statusFilter').value = '';
                document.getElementById('dateFilter').value = '';
                document.getElementById('phoneSearch').value = '';
                document.getElementById('orderNumberSearch').value = '';
                
                // 상태 필터를 '접수' 또는 '배송중'으로 설정
                const statusFilter = document.getElementById('statusFilter');
                statusFilter.value = '접수';
                
                // 필터 적용
                filterOrders();
                
                // 사용자에게 알림
                alert('신규주문 중 접수/배송중 상태인 주문만 표시됩니다.');
            };

            // 교환/반품/취소 진행중 필터링
            window.filterExchangeReturnInProgress = function() {
                // 필터 초기화
                document.getElementById('orderTypeFilter').value = '';
                document.getElementById('statusFilter').value = '';
                document.getElementById('dateFilter').value = '';
                document.getElementById('phoneSearch').value = '';
                document.getElementById('orderNumberSearch').value = '';
                
                // 주문유형을 '교환', '반품', '취소'로 설정
                const orderTypeFilter = document.getElementById('orderTypeFilter');
                orderTypeFilter.value = '교환';
                
                // 상태 필터를 '접수' 또는 '배송중'으로 설정
                const statusFilter = document.getElementById('statusFilter');
                statusFilter.value = '접수';
                
                // 필터 적용
                filterOrders();
                
                // 사용자에게 알림
                alert('교환/반품/취소 중 접수/배송중 상태인 주문만 표시됩니다.');
            };

            // 전체 선택/해제
            window.toggleSelectAll = function() {
                const selectAll = document.getElementById('selectAll');
                const checkboxes = document.querySelectorAll('.order-checkbox');
                
                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectAll.checked;
                });
                
                updateBulkActions();
            };

            // 체크박스 선택 상태 변경 시 일괄 처리 도구 표시/숨김
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('order-checkbox')) {
                    updateBulkActions();
                }
            });

            // 일괄 처리 도구 업데이트
            function updateBulkActions() {
                const checkboxes = document.querySelectorAll('.order-checkbox:checked');
                const bulkActions = document.querySelector('.bulk-actions');
                const selectedCount = document.getElementById('selectedCount');
                
                if (checkboxes.length > 0) {
                    bulkActions.style.display = 'block';
                    selectedCount.textContent = `${checkboxes.length}개 선택됨`;
                } else {
                    bulkActions.style.display = 'none';
                    selectAll.checked = false;
                }
            }

            // 일괄 상태 업데이트
            window.bulkUpdateStatus = function(newStatus) {
                const checkboxes = document.querySelectorAll('.order-checkbox:checked');
                
                if (checkboxes.length === 0) {
                    alert('선택된 주문이 없습니다.');
                    return;
                }
                
                const confirmMessage = `선택된 ${checkboxes.length}개 주문의 상태를 '${newStatus}'로 변경하시겠습니까?`;
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                
                checkboxes.forEach(checkbox => {
                    const orderId = checkbox.value;
                    try {
                        updateOrderStatus(orderId, newStatus);
                        successCount++;
                    } catch (error) {
                        console.error('상태 업데이트 오류:', error);
                        errorCount++;
                    }
                });
                
                // 체크박스 선택 해제
                checkboxes.forEach(checkbox => checkbox.checked = false);
                selectAll.checked = false;
                updateBulkActions();
                
                // 결과 알림
                if (errorCount === 0) {
                    alert(`${successCount}개 주문의 상태가 '${newStatus}'로 변경되었습니다.`);
                } else {
                    alert(`${successCount}개 성공, ${errorCount}개 실패했습니다.`);
                }
            };

            // 7일이 지난 주문 자동 삭제
            async function deleteOldOrders(data) {
                if (!data) return;
                
                const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000); // 7일 전
                const entries = Object.entries(data);
                let deletedCount = 0;
                
                for (const [id, order] of entries) {
                    if (order.createdAt && order.createdAt < sevenDaysAgo) {
                        try {
                            const orderRef = ref(database, `orders/${id}`);
                            await set(orderRef, null); // 삭제
                            deletedCount++;
                        } catch (error) {
                            console.error('주문 삭제 오류:', error);
                        }
                    }
                }
                
                if (deletedCount > 0) {
                    console.log(`${deletedCount}개의 오래된 주문이 삭제되었습니다.`);
                }
            }

            // Excel 내보내기 (필터링된 데이터만)
            window.exportToExcel = function () {
                // 로딩 표시
                const exportBtn = document.querySelector('button[onclick="exportToExcel()"]');
                const originalText = exportBtn.innerHTML;
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> 처리중...';
                
                try {
                    // 현재 테이블에 표시된 데이터 가져오기
                    const tableBody = document.getElementById('ordersTableBody');
                    const rows = tableBody.querySelectorAll('tr');
                    
                    if (rows.length === 0 || (rows.length === 1 && rows[0].textContent.includes('주문이 없습니다'))) {
                        alert("내보낼 주문 데이터가 없습니다.");
                        return;
                    }
                    
                    // 필터링된 데이터 수집
                    const filteredData = [];
                    let processedCount = 0;
                    const totalCount = rows.length;
                    
                    rows.forEach((row) => {
                        // "주문이 없습니다" 메시지 행은 제외
                        if (row.textContent.includes('주문이 없습니다')) {
                            return;
                        }
                        
                        processedCount++;
                        
                        // 1000건마다 진행률 업데이트
                        if (processedCount % 1000 === 0) {
                            const progress = Math.round((processedCount / totalCount) * 100);
                            exportBtn.innerHTML = `<svg class="inline-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> ${progress}%`;
                        }
                        
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 11) {
                            filteredData.push({
                                주문번호: cells[0].textContent.trim(),
                                주문시간: cells[1].textContent.trim(),
                                입금자명: cells[2].textContent.trim(),
                                연락처: cells[3].textContent.trim(),
                                주문유형: cells[4].textContent.trim(),
                                기존주문번호: cells[5].textContent.trim(),
                                구매제품: cells[6].textContent.trim(),
                                주소: cells[7].textContent.trim(),
                                상세주소: cells[8].textContent.trim(),
                                배송메세지: cells[9].textContent.trim(),
                                배송상태: cells[10].textContent.trim()
                            });
                        }
                    });
                    
                    // 데이터 개수 확인
                    if (filteredData.length > 10000) {
                        const confirm = window.confirm(
                            `총 ${filteredData.length.toLocaleString()}건의 데이터를 내보냅니다.\n` +
                            `처리 시간이 오래 걸릴 수 있습니다.\n계속하시겠습니까?`
                        );
                        if (!confirm) {
                            return;
                        }
                    }

                    // Excel 파일 생성
                    const ws = XLSX.utils.json_to_sheet(filteredData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "주문목록");

                    const fileName = `주문목록_${new Date().toISOString().split("T")[0]}_${filteredData.length}건.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                    // 완료 메시지
                    alert(`Excel 파일이 생성되었습니다.\n총 ${filteredData.length.toLocaleString()}건의 데이터가 포함되었습니다.`);
                    
                } catch (error) {
                    console.error("Excel 내보내기 오류:", error);
                    alert("Excel 내보내기 중 오류가 발생했습니다.");
                } finally {
                    // 버튼 복원
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = originalText;
                }
            };
        </script>
    </body>
</html>
