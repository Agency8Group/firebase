<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        />
        <title>0000셀러 주문 수집 페이지</title>

        <!-- Firebase Authentication SDK -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
            import {
                getAuth,
                signInWithEmailAndPassword,
                onAuthStateChanged,
            } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

            // Firebase 설정 (config.js에서 로드)
            const firebaseConfig = window.firebaseConfig;

            // Firebase 초기화
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);

            // 전역 변수로 auth와 app 객체 설정
            window.auth = auth;
            window.app = app;

            // 인증 상태 변경 감지 (index에서는 자동 이동하지 않음)
            onAuthStateChanged(auth, () => {
                // no-op: 관리자 버튼으로 시작한 로그인 흐름에서만 이동 처리
            });

            // 로그인 함수
            window.login = async function () {
                const email = document.getElementById("loginEmail").value;
                const password = document.getElementById("loginPassword").value;

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    document.getElementById("loginError").textContent = "";
                    // 관리자 버튼에서 시작한 경우에만 admin으로 이동
                    if (window.isAdminLoginFlow) {
                        window.open("admin.html", "_blank");
                        window.isAdminLoginFlow = false;
                        document.getElementById("loginModal").style.display =
                            "none";
                    }
                } catch (error) {
                    document.getElementById("loginError").textContent =
                        "이메일 주소 및 비밀번호를 입력해주세요.";
                }
            };
        </script>

        <style>
            *,
            *::before,
            *::after {
                box-sizing: border-box;
            }

            body {
                font-family: Arial, sans-serif;
                margin: 24px;
                line-height: 1.45;
                -webkit-text-size-adjust: 100%;
                background-color: #f8f9fa;
            }

            .wrap {
                max-width: 520px;
                margin: 0 auto;
                background: white;
                padding: 24px;
                border-radius: 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            h1 {
                font-size: 20px;
                margin-bottom: 24px;
                text-align: center;
                color: #333;
            }

            .title-row {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
                margin-bottom: 20px;
            }

            .icon-btn {
                background: #f0f0f0;
                color: #222;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 8px 10px;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .icon-btn:hover {
                background: #e8e8e8;
            }

            .field {
                margin: 16px 0;
            }

            label {
                display: block;
                margin-bottom: 6px;
                font-weight: bold;
                color: #333;
            }

            input[type="text"],
            input[type="tel"],
            select {
                width: 100%;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 16px;
                min-height: 44px;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                transition: border-color 0.2s ease;
            }

            input::placeholder {
                color: #999;
                font-size: 14px;
                line-height: 1.4;
                opacity: 1;
            }

            select option[disabled] {
                color: #999;
                font-style: italic;
            }

            select:invalid {
                color: #999;
            }

            select:valid {
                color: #333;
            }

            #product::placeholder {
                font-size: 12px;
                line-height: 1.2;
                word-break: keep-all;
                white-space: normal;
            }

            input[type="text"]:focus,
            input[type="tel"]:focus,
            select:focus {
                outline: none;
                border-color: #007bff;
                box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
            }

            button {
                padding: 12px 16px;
                border: 0;
                background: #007bff;
                color: #fff;
                border-radius: 6px;
                cursor: pointer;
                font-size: 16px;
                min-height: 48px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
                transition: background-color 0.2s ease;
                -webkit-user-select: none;
                user-select: none;
            }

            button:hover {
                background: #0056b3;
                transform: translateY(-1px);
            }

            button:active {
                background: #004085;
                transform: translateY(0);
            }

            button[disabled] {
                opacity: 0.6;
                cursor: not-allowed;
            }

            #btnSubmit {
                width: 100%;
                background: #28a745;
                margin-top: 20px;
            }

            #btnSubmit:hover {
                background: #1e7e34;
            }

            #btnFindAddr {
                background: #e0e0e0;
                color: #666;
            }

            #btnFindAddr:hover {
                background: #d0d0d0;
            }

            .msg {
                margin-top: 12px;
                font-size: 14px;
                padding: 10px;
                border-radius: 4px;
            }

            .msg.error {
                color: #721c24;
                background-color: #f8d7da;
                border: 1px solid #f5c6cb;
            }

            .msg.success {
                color: #155724;
                background-color: #d4edda;
                border: 1px solid #c3e6cb;
            }

            .addr-row {
                display: flex;
                gap: 8px;
            }

            .addr-row input {
                flex: 1;
            }

            /* Radio Button Styles */
            .radio-group {
                display: flex;
                flex-direction: column;
                gap: 8px;
                flex-wrap: nowrap;
            }

            .radio-row {
                display: flex;
                gap: 12px;
                justify-content: center;
            }

            .radio-item {
                display: flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                padding: 8px 12px;
                border: 1px solid #e9ecef;
                border-radius: 6px;
                background: white;
                transition: all 0.2s ease;
                width: 100%;
                justify-content: flex-start;
                min-height: 36px;
            }

            .radio-item:hover {
                border-color: #007bff;
                background: #f8f9ff;
            }

            .radio-item input[type="radio"] {
                display: none;
            }

            .radio-custom {
                width: 14px;
                height: 14px;
                border: 2px solid #ddd;
                border-radius: 50%;
                position: relative;
                transition: all 0.2s ease;
                flex-shrink: 0;
            }

            .radio-item input[type="radio"]:checked + .radio-custom {
                border-color: #007bff;
                background: #007bff;
            }

            .radio-item input[type="radio"]:checked + .radio-custom::after {
                content: "";
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 5px;
                height: 5px;
                background: white;
                border-radius: 50%;
            }

            .radio-item input[type="radio"]:checked ~ .radio-label {
                color: #007bff;
                font-weight: 600;
            }

            .radio-label {
                font-size: 13px;
                color: #495057;
                transition: all 0.2s ease;
                font-weight: 500;
            }

            /* SVG Icon Styles */
            .inline-icon {
                width: 18px;
                height: 18px;
                vertical-align: middle;
                margin-right: 6px;
            }

            .status-indicator {
                display: inline-block;
                width: 16px;
                height: 16px;
                border-radius: 50%;
                margin-left: 12px;
                vertical-align: middle;
                border: 2px solid #ddd;
                animation: pulse 2s infinite;
            }

            .status-indicator.connected {
                background-color: #28a745;
                border-color: #28a745;
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
                animation: pulse 2s infinite;
            }

            .status-indicator.disconnected {
                background-color: #dc3545;
                border-color: #dc3545;
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0% {
                    box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
                }
            }

            .status-indicator.disconnected {
                animation: pulse-disconnected 2s infinite;
            }

            @keyframes pulse-disconnected {
                0% {
                    box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
                }
            }

            @media (max-width: 768px),
                (max-device-width: 768px),
                (orientation: portrait) and (max-width: 1024px) {
                body {
                    margin: 4px;
                    font-size: 15px;
                    -webkit-text-size-adjust: 100%;
                    -webkit-tap-highlight-color: transparent;
                }

                .wrap {
                    padding: 20px 16px;
                    border-radius: 12px;
                    max-width: 100%;
                    box-sizing: border-box;
                    overflow-x: hidden;
                    margin: 8px;
                }

                h1 {
                    font-size: 20px;
                    margin-bottom: 24px;
                    line-height: 1.3;
                }

                .field {
                    margin: 20px 0;
                }

                label {
                    font-size: 15px;
                    margin-bottom: 8px;
                    font-weight: 600;
                    color: #2c3e50;
                }

                input[type="text"],
                input[type="tel"],
                select {
                    font-size: 16px;
                    padding: 16px 14px;
                    min-height: 52px;
                    border-radius: 8px;
                    border: 2px solid #e9ecef;
                    background-color: #fafafa;
                }

                input[type="text"]:focus,
                input[type="tel"]:focus,
                select:focus {
                    border-color: #007bff;
                    background-color: white;
                    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
                }

                .addr-row {
                    flex-direction: column;
                    gap: 12px;
                }

                .radio-group {
                    gap: 8px;
                    flex-wrap: nowrap;
                    width: 100%;
                    overflow: hidden;
                }

                .radio-row {
                    gap: 10px;
                    flex-wrap: wrap;
                    justify-content: center;
                }

                .radio-item {
                    flex: 1;
                    padding: 12px 14px;
                    flex-shrink: 0;
                    border-radius: 8px;
                    min-height: 48px;
                    max-width: calc(50% - 5px);
                    border: 2px solid #e9ecef;
                    background: white;
                    transition: all 0.2s ease;
                }

                .radio-item:hover,
                .radio-item:active {
                    border-color: #007bff;
                    background: #f8f9ff;
                    transform: translateY(-1px);
                }

                .radio-label {
                    font-size: 13px;
                    font-weight: 500;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }

                #btnAdmin {
                    display: none !important;
                }

                .simple-footer {
                    margin-top: 32px;
                    padding: 20px 0;
                }

                /* 모바일 전용 추가 최적화 */
                button {
                    min-height: 56px;
                    font-size: 16px;
                    padding: 16px 20px;
                    border-radius: 8px;
                    font-weight: 600;
                    letter-spacing: 0.5px;
                }

                #btnSubmit {
                    min-height: 60px;
                    font-size: 18px;
                    font-weight: 700;
                    background: linear-gradient(135deg, #28a745, #20c997);
                    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                    margin-top: 24px;
                }

                #btnSubmit:hover,
                #btnSubmit:active {
                    background: linear-gradient(135deg, #1e7e34, #1a9f7a);
                    transform: translateY(-2px);
                    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
                }

                .modal-content {
                    padding: 24px 20px;
                    margin: 20px;
                    width: calc(100% - 40px);
                    max-width: none;
                    border-radius: 16px;
                }

                .modal-buttons {
                    flex-direction: column;
                    gap: 16px;
                }

                .btn-confirm,
                .btn-cancel {
                    min-height: 56px;
                    font-size: 16px;
                    font-weight: 600;
                }

                .order-summary {
                    font-size: 14px;
                    padding: 16px;
                    border-radius: 8px;
                }

                .order-summary-item {
                    margin-bottom: 8px;
                    padding: 4px 0;
                }

                /* 모바일에서 터치하기 쉽게 간격 조정 */
                .field {
                    margin: 20px 0;
                }

                input[type="text"],
                input[type="tel"],
                select {
                    margin-bottom: 6px;
                }

                /* 모바일에서 라디오 버튼 터치 영역 확대 */
                .radio-item {
                    min-height: 48px;
                    padding: 12px 14px;
                }

                /* 모바일에서 주소찾기 버튼 최적화 */
                #btnFindAddr {
                    min-height: 52px;
                    font-size: 15px;
                    padding: 14px 18px;
                    background: linear-gradient(135deg, #6c757d, #5a6268);
                    color: white;
                    border: none;
                    font-weight: 600;
                }

                #btnFindAddr:hover,
                #btnFindAddr:active {
                    background: linear-gradient(135deg, #5a6268, #495057);
                    transform: translateY(-1px);
                }

                /* 모바일에서 메시지 스타일 개선 */
                .msg {
                    margin-top: 16px;
                    padding: 14px 16px;
                    border-radius: 8px;
                    font-size: 15px;
                    font-weight: 500;
                }

                /* 모바일에서 처리 제한 안내 개선 */
                #processingLimits {
                    margin-top: 12px;
                    padding: 12px 16px;
                    background: #fff3cd;
                    border: 1px solid #ffeaa7;
                    border-radius: 8px;
                    font-size: 13px;
                    line-height: 1.5;
                }

                /* 모바일에서 인라인 아이콘 크기 조정 */
                .inline-icon {
                    width: 20px;
                    height: 20px;
                    margin-right: 8px;
                }

                /* 모바일에서 상태 표시기 개선 */
                .status-indicator {
                    width: 18px;
                    height: 18px;
                    margin-left: 16px;
                }
            }

            /* 모바일 터치 최적화 추가 스타일 */
            @media (max-width: 768px) {
                /* 터치 스크롤 최적화 */
                * {
                    -webkit-overflow-scrolling: touch;
                    scroll-behavior: smooth;
                }

                /* 모바일에서 포커스 링 제거 */
                *:focus {
                    outline: none;
                }

                /* 모바일에서 선택 텍스트 스타일 */
                ::selection {
                    background: rgba(0, 123, 255, 0.2);
                    color: #2c3e50;
                }

                /* 모바일에서 입력 필드 자동 확대 방지 */
                input[type="text"],
                input[type="tel"],
                select {
                    font-size: 16px !important;
                    transform: none !important;
                }

                /* 모바일에서 버튼 터치 피드백 */
                button:active {
                    transform: scale(0.98);
                    transition: transform 0.1s ease;
                }

                /* 모바일에서 라디오 버튼 터치 피드백 */
                .radio-item:active {
                    transform: scale(0.95);
                    transition: transform 0.1s ease;
                }

                /* 모바일에서 스크롤바 숨김 */
                ::-webkit-scrollbar {
                    display: none;
                }

                /* 모바일에서 텍스트 선택 방지 (버튼 제외) */
                .wrap {
                    -webkit-user-select: none;
                    -moz-user-select: none;
                    -ms-user-select: none;
                    user-select: none;
                }

                input,
                textarea,
                select {
                    -webkit-user-select: text;
                    -moz-user-select: text;
                    -ms-user-select: text;
                    user-select: text;
                }
            }

            /* Simple Footer */
            .simple-footer {
                margin-top: 40px;
                padding: 20px 0;
                text-align: center;
                border-top: 1px solid #e9ecef;
            }

            .simple-footer a {
                color: #6c757d;
                text-decoration: none;
                font-size: 12px;
                transition: color 0.2s ease;
            }

            .simple-footer a:hover {
                color: #495057;
            }

            /* 모달 스타일 */
            .modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }

            .modal-content {
                background: white;
                padding: 24px;
                border-radius: 12px;
                max-width: 90%;
                width: 400px;
                max-height: 80vh;
                overflow-y: auto;
            }

            .modal-content h3 {
                margin: 0 0 16px 0;
                color: #212529;
                font-size: 18px;
                text-align: center;
            }

            .order-summary {
                background: #f8f9fa;
                padding: 16px;
                border-radius: 8px;
                margin-bottom: 20px;
                font-size: 14px;
                line-height: 1.5;
            }

            .order-summary-item {
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
            }

            .order-summary-item:last-child {
                margin-bottom: 0;
            }

            .modal-buttons {
                display: flex;
                gap: 12px;
                justify-content: center;
            }

            .btn-confirm {
                background: #28a745;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                min-height: 44px;
                flex: 1;
            }

            .btn-confirm:hover {
                background: #1e7e34;
            }

            .btn-cancel {
                background: #6c757d;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                min-height: 44px;
                flex: 1;
            }

            .btn-cancel:hover {
                background: #545b62;
            }

            @media (max-width: 768px) {
                .modal-content {
                    padding: 20px;
                    margin: 16px;
                }

                .modal-buttons {
                    flex-direction: column;
                }
            }

            /* 로그인 모달 스타일 */
            .login-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 2000;
            }

            .login-container {
                background: white;
                padding: 32px;
                border-radius: 12px;
                max-width: 90%;
                width: 400px;
                text-align: center;
            }

            .login-container h2 {
                margin: 0 0 24px 0;
                color: #333;
                font-size: 20px;
            }

            .login-input {
                width: 100%;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 16px;
                margin-bottom: 16px;
                box-sizing: border-box;
            }

            .login-input:focus {
                outline: none;
                border-color: #007bff;
                box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
            }

            .login-btn {
                width: 100%;
                background: #007bff;
                color: white;
                border: none;
                padding: 12px;
                border-radius: 6px;
                font-size: 16px;
                cursor: pointer;
                transition: background-color 0.2s ease;
            }

            .login-btn:hover {
                background: #0056b3;
            }

            .login-error {
                color: #dc3545;
                font-size: 14px;
                margin-top: 12px;
                min-height: 20px;
            }

            .close-btn {
                position: absolute;
                top: 16px;
                right: 16px;
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #666;
                padding: 0;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .close-btn:hover {
                color: #333;
            }
        </style>
    </head>
    <body>
        <!-- 로그인 모달 -->
        <div id="loginModal" class="login-modal">
            <div class="login-container">
                <button class="close-btn" onclick="closeLoginModal()">
                    &times;
                </button>
                <h2>관리자 로그인</h2>
                <input
                    type="email"
                    id="loginEmail"
                    class="login-input"
                    placeholder="이메일 주소"
                    required
                />
                <input
                    type="password"
                    id="loginPassword"
                    class="login-input"
                    placeholder="비밀번호"
                    required
                />
                <button onclick="login()" class="login-btn">로그인</button>
                <div id="loginError" class="login-error"></div>
            </div>
        </div>

        <div class="wrap">
            <h1>
                <svg
                    class="inline-icon"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                >
                    <path
                        d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h4c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"
                    />
                </svg>
                0000셀러 주문 수집<span
                    id="status"
                    class="status-indicator disconnected"
                ></span>
            </h1>

            <form id="orderForm">
                <div class="field">
                    <label>주문 유형 *</label>
                    <div class="radio-group">
                        <div class="radio-row">
                            <label class="radio-item">
                                <input
                                    type="radio"
                                    name="orderType"
                                    value="신규주문"
                                    checked
                                />
                                <span class="radio-custom"></span>
                                <span class="radio-label">신규주문</span>
                            </label>
                            <label class="radio-item">
                                <input
                                    type="radio"
                                    name="orderType"
                                    value="배송조회"
                                />
                                <span class="radio-custom"></span>
                                <span class="radio-label">배송조회</span>
                            </label>
                        </div>
                        <div class="radio-row">
                            <label class="radio-item">
                                <input
                                    type="radio"
                                    name="orderType"
                                    value="교환"
                                />
                                <span class="radio-custom"></span>
                                <span class="radio-label">교환</span>
                            </label>
                            <label class="radio-item">
                                <input
                                    type="radio"
                                    name="orderType"
                                    value="반품"
                                />
                                <span class="radio-custom"></span>
                                <span class="radio-label">반품</span>
                            </label>
                            <label class="radio-item">
                                <input
                                    type="radio"
                                    name="orderType"
                                    value="취소"
                                />
                                <span class="radio-custom"></span>
                                <span class="radio-label">취소</span>
                            </label>
                        </div>
                    </div>
                    <div
                        id="processingLimits"
                        style="
                            margin-top: 8px;
                            font-size: 12px;
                            color: #666;
                            line-height: 1.4;
                            display: none;
                        "
                    >
                        <strong>처리 제한:</strong><br />
                        • 취소: 접수 상태에서만 가능<br />
                        • 교환/반품: 배송완료 상태에서만 가능
                    </div>
                </div>

                <div
                    class="field"
                    id="existingOrderField"
                    style="display: none"
                >
                    <label for="existingOrderNumber">기존 주문번호 *</label>
                    <input
                        type="text"
                        id="existingOrderNumber"
                        name="existingOrderNumber"
                        placeholder="교환/반품/취소할 주문번호를 입력해주세요"
                    />
                </div>

                <div class="field">
                    <label for="customerName">고객명 *</label>
                    <input
                        type="text"
                        id="customerName"
                        name="customerName"
                        placeholder="입금자명 과 동일한 성함을 넣어주세요"
                        required
                    />
                </div>

                <div class="field">
                    <label for="phone">연락처 *</label>
                    <input
                        type="tel"
                        id="phone"
                        name="phone"
                        placeholder="010-0000-0000"
                        required
                    />
                </div>

                <div class="field">
                    <label for="product">상품명 *</label>
                    <input
                        type="text"
                        id="product"
                        name="product"
                        placeholder="상품명/사이즈/색상 순
 브랜드 티셔츠 s사이즈 블랙"
                        required
                    />
                </div>

                <div class="field">
                    <label for="quantity">수량 *</label>
                    <select id="quantity" name="quantity" required>
                        <option value="" disabled selected>
                            수량을 선택하세요
                        </option>
                        <option value="1">1개</option>
                        <option value="2">2개</option>
                        <option value="3">3개</option>
                        <option value="4">4개</option>
                        <option value="5">5개</option>
                        <option value="6">6개</option>
                        <option value="7">7개</option>
                        <option value="8">8개</option>
                        <option value="9">9개</option>
                        <option value="10">10개</option>
                    </select>
                </div>

                <div class="field">
                    <label for="zipcode">우편번호</label>
                    <div class="addr-row">
                        <input
                            type="text"
                            id="zipcode"
                            name="zipcode"
                            placeholder="우편번호"
                            readonly
                        />
                        <button type="button" id="btnFindAddr" class="icon-btn">
                            주소찾기
                        </button>
                    </div>
                </div>

                <div class="field">
                    <label for="address">주소</label>
                    <input
                        type="text"
                        id="address"
                        name="address"
                        placeholder="주소를 입력해주세요"
                    />
                </div>

                <div class="field">
                    <label for="detailAddress">상세주소</label>
                    <input
                        type="text"
                        id="detailAddress"
                        name="detailAddress"
                        placeholder="상세주소를 입력해주세요"
                    />
                </div>

                <div class="field">
                    <label for="memo">배송메세지</label>
                    <input
                        type="text"
                        id="memo"
                        name="memo"
                        placeholder="배송 관련 요청사항을 입력해주세요"
                    />
                </div>

                <!-- 환불 계좌정보 입력칸 (반품/취소 시에만 표시) -->
                <div
                    class="field"
                    id="refundAccountField"
                    style="display: none"
                >
                    <label for="refundAccount">환불받을 계좌정보 *</label>
                    <input
                        type="text"
                        id="refundAccount"
                        name="refundAccount"
                        placeholder="은행명 - 계좌번호 - 예금주명 (예: 신한은행 - 110-123456789 - 홍길동)"
                    />
                </div>

                <button type="submit" id="btnSubmit">
                    <svg
                        class="inline-icon"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                    >
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                    </svg>
                    주문 접수하기
                </button>
            </form>

            <div id="message" class="msg" style="display: none"></div>

            <!-- 주문 완료 확인 모달 -->
            <div id="orderConfirmModal" class="modal" style="display: none">
                <div class="modal-content">
                    <h3>📋 주문 내역 확인</h3>
                    <div id="orderSummary" class="order-summary"></div>
                    <div class="modal-buttons">
                        <button
                            type="button"
                            id="confirmOrder"
                            class="btn-confirm"
                        >
                            네, 맞습니다
                        </button>
                        <button
                            type="button"
                            id="cancelOrder"
                            class="btn-cancel"
                        >
                            수정하기
                        </button>
                    </div>
                </div>
            </div>

            <!-- 주문내역 저장 확인 모달 -->
            <div id="saveOrderModal" class="modal" style="display: none">
                <div class="modal-content">
                    <h3>💾 주문내역 저장</h3>
                    <p>주문내역을 앨범에 저장하시겠습니까?</p>
                    <div class="modal-buttons">
                        <button
                            type="button"
                            id="saveToAlbum"
                            class="btn-confirm"
                        >
                            저장하기
                        </button>
                        <button type="button" id="skipSave" class="btn-cancel">
                            건너뛰기
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 관리자 버튼 (우측 상단) -->
        <button
            type="button"
            id="btnAdmin"
            class="icon-btn"
            style="
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 40px;
                height: 40px;
            "
        >
            <svg
                class="inline-icon"
                viewBox="0 0 24 24"
                fill="currentColor"
                style="margin: 0"
            >
                <path
                    d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                />
            </svg>
        </button>

        <!-- Simple Footer -->
        <footer class="simple-footer">
            <a href="https://cx-tech-builder.netlify.app/" target="_blank">
                Powered by CX Tech Builder
            </a>
        </footer>

        <!-- 설정 파일 (Firebase 설정 로드) -->
        <script src="config.js"></script>

        <!-- Firebase SDK -->
        <script type="module">
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
            import {
                getDatabase,
                ref,
                push,
                onValue,
                get,
            } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

            // Firebase 설정은 이미 head에서 초기화됨
            const database = getDatabase(window.app);

            // DOM 요소들
            const statusDiv = document.getElementById("status");
            const orderForm = document.getElementById("orderForm");
            const messageDiv = document.getElementById("message");
            const btnAdmin = document.getElementById("btnAdmin");

            // 연결 상태 확인
            const connectedRef = ref(database, ".info/connected");
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    statusDiv.className = "status-indicator connected";
                } else {
                    statusDiv.className = "status-indicator disconnected";
                }
            });

            // 주문 접수 처리
            orderForm.addEventListener("submit", async (e) => {
                e.preventDefault();

                const submitBtn = document.getElementById("btnSubmit");
                submitBtn.disabled = true;
                submitBtn.textContent = "📤 주문 접수 중...";

                try {
                    const formData = new FormData(orderForm);
                    const orderType = formData.get("orderType");
                    const existingOrderNumber = formData.get(
                        "existingOrderNumber"
                    );
                    const phone = formData.get("phone");

                    // 교환/반품/취소인 경우 기존 주문 매칭 검증 및 상태 확인
                    if (orderType !== "신규주문") {
                        const existingOrder = await findExistingOrder(
                            existingOrderNumber,
                            phone
                        );
                        if (!existingOrder) {
                            showMessage(
                                "❌ 기존 주문을 찾을 수 없습니다. 주문번호와 휴대폰번호를 확인해주세요.",
                                "error"
                            );
                            return;
                        }

                        // 주문 상태에 따른 처리 가능 여부 확인
                        const statusCheck = await checkOrderStatusForClaim(
                            existingOrderNumber,
                            orderType
                        );
                        if (!statusCheck.canProcess) {
                            showMessage(`❌ ${statusCheck.reason}`, "error");
                            return;
                        }

                        // 반품/취소 시 환불 계좌정보 필수 입력 확인
                        if (
                            (orderType === "반품" || orderType === "취소") &&
                            !formData.get("refundAccount")
                        ) {
                            showMessage(
                                "❌ 환불받을 계좌정보를 입력해주세요.",
                                "error"
                            );
                            return;
                        }
                    }

                    // 주문 내역 생성
                    const orderData = {
                        customerName: formData.get("customerName"),
                        phone: formData.get("phone"),
                        product: formData.get("product"),
                        quantity: parseInt(formData.get("quantity")),
                        orderType: orderType,
                        existingOrderNumber: existingOrderNumber || null,
                        zipcode: formData.get("zipcode"),
                        address: formData.get("address"),
                        detailAddress: formData.get("detailAddress"),
                        memo: formData.get("memo"),
                        refundAccount: formData.get("refundAccount") || null,
                        status: getStatusByOrderType(orderType),
                        createdAt: Date.now(),
                        orderNumber: generateOrderNumber(),
                    };

                    // 주문 내역 확인 모달 표시
                    showOrderConfirmModal(orderData);
                } catch (error) {
                    console.error("주문 접수 오류:", error);
                    showMessage(
                        "❌ 주문 접수 중 오류가 발생했습니다. 다시 시도해주세요.",
                        "error"
                    );
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = "📦 주문 접수하기";
                }
            });

            // 기존 주문 검색 (월별 폴더 구조에서 검색)
            async function findExistingOrder(orderNumber, phone = "") {
                try {
                    const ordersRef = ref(database, "orders");
                    const snapshot = await get(ordersRef);
                    const data = snapshot.val();

                    if (!data) return null;

                    // 모든 월별 폴더에서 주문 검색
                    let allOrders = [];
                    for (const [yearMonth, monthOrders] of Object.entries(
                        data
                    )) {
                        if (monthOrders && typeof monthOrders === "object") {
                            const monthOrderEntries =
                                Object.entries(monthOrders);
                            allOrders = allOrders.concat(monthOrderEntries);
                        }
                    }
                    let existingOrder;

                    if (phone) {
                        // 휴대폰번호와 주문번호 모두로 검색 (주문 접수 시)
                        existingOrder = allOrders.find(
                            ([id, order]) =>
                                order.orderNumber === orderNumber &&
                                order.phone === phone
                        );
                    } else {
                        // 주문번호만으로 검색 (자동 정보 로드 시)
                        existingOrder = allOrders.find(
                            ([id, order]) => order.orderNumber === orderNumber
                        );
                    }

                    return existingOrder ? existingOrder[1] : null;
                } catch (error) {
                    console.error("기존 주문 검색 오류:", error);
                    return null;
                }
            }

            // 주문 유형에 따른 상태 설정
            function getStatusByOrderType(orderType) {
                // 모든 접수는 "접수"로 통일 (주문유형으로 구분)
                return "접수";
            }

            // 주문번호 생성
            function generateOrderNumber() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, "0");
                const day = String(now.getDate()).padStart(2, "0");
                const hours = String(now.getHours()).padStart(2, "0");
                const minutes = String(now.getMinutes()).padStart(2, "0");
                const seconds = String(now.getSeconds()).padStart(2, "0");

                return `ORD${year}${month}${day}${hours}${minutes}${seconds}`;
            }

            // 주문 내역 확인 모달 표시
            function showOrderConfirmModal(orderData) {
                const modal = document.getElementById("orderConfirmModal");
                const summary = document.getElementById("orderSummary");

                summary.innerHTML = `
                    <div class="order-summary-item">
                        <span>고객명:</span>
                        <span>${orderData.customerName}</span>
                    </div>
                    <div class="order-summary-item">
                        <span>연락처:</span>
                        <span>${orderData.phone}</span>
                    </div>
                    <div class="order-summary-item">
                        <span>상품명:</span>
                        <span>${orderData.product}</span>
                    </div>
                    <div class="order-summary-item">
                        <span>수량:</span>
                        <span>${orderData.quantity}개</span>
                    </div>
                    <div class="order-summary-item">
                        <span>주문 유형:</span>
                        <span>${orderData.orderType}</span>
                    </div>
                    ${
                        orderData.address
                            ? `
                    <div class="order-summary-item">
                        <span>주소:</span>
                        <span>${orderData.address} ${
                                  orderData.detailAddress || ""
                              }</span>
                    </div>
                    `
                            : ""
                    }
                    ${
                        orderData.memo
                            ? `
                    <div class="order-summary-item">
                        <span>메모:</span>
                        <span>${orderData.memo}</span>
                    </div>
                    `
                            : ""
                    }
                    ${
                        orderData.refundAccount
                            ? `
                    <div class="order-summary-item">
                        <span>환불 계좌정보:</span>
                        <span>${orderData.refundAccount}</span>
                    </div>
                    `
                            : ""
                    }
                    <div class="order-summary-item">
                        <span>입금계좌:</span>
                        <span>0000-0000-0000-0000 (0000셀러)</span>
                    </div>
                `;

                modal.style.display = "flex";

                // 모달에 주문 데이터 저장
                modal.orderData = orderData;
            }

            // 주문내역 저장 모달 표시
            function showSaveOrderModal(orderData) {
                const modal = document.getElementById("saveOrderModal");
                modal.style.display = "flex";
                modal.orderData = orderData;
            }

            // 주문내역을 이미지로 생성
            function generateOrderImage(orderData) {
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");

                canvas.width = 400;
                canvas.height = 600;

                // 배경
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(0, 0, 400, 600);

                // 제목
                ctx.fillStyle = "#333333";
                ctx.font = "bold 24px Arial";
                ctx.textAlign = "center";
                ctx.fillText("주문 내역", 200, 40);

                // 주문 정보
                ctx.font = "16px Arial";
                ctx.textAlign = "left";
                let y = 80;

                const items = [
                    `주문번호: ${orderData.orderNumber}`,
                    `고객명: ${orderData.customerName}`,
                    `연락처: ${orderData.phone}`,
                    `상품명: ${orderData.product}`,
                    `수량: ${orderData.quantity}개`,
                    `주문 유형: ${orderData.orderType}`,
                    `주문 시간: ${new Date(orderData.createdAt).toLocaleString(
                        "ko-KR"
                    )}`,
                    `입금계좌: 0000-0000-0000-0000 (0000셀러)`,
                ];

                if (orderData.address) {
                    items.push(
                        `주소: ${orderData.address} ${
                            orderData.detailAddress || ""
                        }`
                    );
                }
                if (orderData.memo) {
                    items.push(`메모: ${orderData.memo}`);
                }
                if (orderData.refundAccount) {
                    items.push(`환불 계좌정보: ${orderData.refundAccount}`);
                }

                items.forEach((item) => {
                    ctx.fillText(item, 20, y);
                    y += 30;
                });

                return canvas.toDataURL("image/png");
            }

            // 메시지 표시
            function showMessage(text, type) {
                messageDiv.textContent = text;
                messageDiv.className = `msg ${type}`;
                messageDiv.style.display = "block";

                setTimeout(() => {
                    messageDiv.style.display = "none";
                }, 5000);
            }

            // 연락처 자동 포맷팅
            const phoneInput = document.getElementById("phone");
            phoneInput.addEventListener("input", function (e) {
                let value = e.target.value.replace(/[^0-9]/g, ""); // 숫자만 추출

                if (value.length <= 3) {
                    e.target.value = value;
                } else if (value.length <= 7) {
                    e.target.value = value.slice(0, 3) + "-" + value.slice(3);
                } else {
                    e.target.value =
                        value.slice(0, 3) +
                        "-" +
                        value.slice(3, 7) +
                        "-" +
                        value.slice(7, 11);
                }
            });

            // 주문 유형 변경 시 필드 표시/숨김 (성능 최적화)
            const orderTypeRadios = document.querySelectorAll(
                'input[name="orderType"]'
            );
            const existingOrderField =
                document.getElementById("existingOrderField");
            const existingOrderInput = document.getElementById(
                "existingOrderNumber"
            );

            // 주문 상태에 따른 교환/반품/취소 처리 제한 함수
            async function checkOrderStatusForClaim(orderNumber, claimType) {
                try {
                    const ordersRef = ref(database, "orders");
                    const snapshot = await get(ordersRef);
                    const data = snapshot.val();

                    if (!data)
                        return {
                            canProcess: false,
                            reason: "주문 데이터를 찾을 수 없습니다.",
                        };

                    // 월별 폴더 구조에서 모든 주문 검색
                    let allOrders = [];
                    for (const [yearMonth, monthOrders] of Object.entries(
                        data
                    )) {
                        if (monthOrders && typeof monthOrders === "object") {
                            const monthOrderEntries =
                                Object.entries(monthOrders);
                            allOrders = allOrders.concat(monthOrderEntries);
                        }
                    }

                    // 해당 주문번호로 원본 주문 찾기
                    const originalOrder = allOrders.find(
                        ([id, order]) => order.orderNumber === orderNumber
                    );

                    if (!originalOrder) {
                        return {
                            canProcess: false,
                            reason: "해당 주문번호를 찾을 수 없습니다.",
                        };
                    }

                    const status = originalOrder[1].status;

                    // 취소는 접수 상태에서만 가능
                    if (claimType === "취소") {
                        if (status !== "접수") {
                            return {
                                canProcess: false,
                                reason: `취소는 접수 상태에서만 가능합니다. (현재 상태: ${status})`,
                            };
                        }
                    }

                    // 교환/반품은 배송완료 상태에서만 가능
                    if (claimType === "교환" || claimType === "반품") {
                        if (status !== "배송완료") {
                            return {
                                canProcess: false,
                                reason: `교환/반품은 배송완료 상태에서만 가능합니다. (현재 상태: ${status})`,
                            };
                        }
                    }

                    return { canProcess: true };
                } catch (error) {
                    console.error("주문 상태 확인 오류:", error);
                    return {
                        canProcess: false,
                        reason: "주문 상태 확인 중 오류가 발생했습니다.",
                    };
                }
            }

            // 교환/반품/취소 시 숨길 필드들
            const customerNameField = document.querySelector(
                ".field:nth-child(3)"
            ); // 고객명
            const phoneField = document.querySelector(".field:nth-child(4)"); // 연락처
            const zipcodeField = document.querySelector(".field:nth-child(7)"); // 우편번호
            const addressField = document.querySelector(".field:nth-child(8)"); // 주소
            const detailAddressField = document.querySelector(
                ".field:nth-child(9)"
            ); // 상세주소
            const memoField = document.querySelector(".field:nth-child(10)"); // 요청사항
            const refundAccountField =
                document.getElementById("refundAccountField"); // 환불 계좌정보

            // 상품/수량 필드 DOM
            const productField = document
                .getElementById("product")
                ?.closest(".field");
            const quantityField = document
                .getElementById("quantity")
                ?.closest(".field");

            orderTypeRadios.forEach((radio) => {
                radio.addEventListener("change", async function () {
                    const memoLabel =
                        document.querySelector('label[for="memo"]');
                    const memoInput = document.getElementById("memo");
                    const customerNameInput =
                        document.getElementById("customerName");
                    const phoneInputEl = document.getElementById("phone");
                    const productInput = document.getElementById("product");
                    const quantityInput = document.getElementById("quantity");
                    const submitBtn = document.getElementById("btnSubmit");

                    // 처리 제한 안내 숨김
                    const processingLimits =
                        document.getElementById("processingLimits");

                    if (this.value === "배송조회") {
                        // 배송조회: 주문번호만 입력, 나머지는 숨김
                        existingOrderField.style.display = "block";
                        existingOrderInput.required = true;

                        customerNameField.style.display = "none";
                        phoneField.style.display = "none";
                        zipcodeField.style.display = "none";
                        addressField.style.display = "none";
                        detailAddressField.style.display = "none";
                        memoField.style.display = "none";
                        refundAccountField.style.display = "none";
                        if (productField) productField.style.display = "none";
                        if (quantityField) quantityField.style.display = "none";

                        // 필수 해제
                        if (customerNameInput)
                            customerNameInput.required = false;
                        if (phoneInputEl) phoneInputEl.required = false;
                        if (productInput) productInput.required = false;
                        if (quantityInput) quantityInput.required = false;

                        existingOrderInput.placeholder =
                            "배송조회할 주문번호를 입력하세요";
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = "🔍 배송조회하기";
                        }
                        return;
                    }

                    if (this.value !== "신규주문") {
                        // 교환/반품/취소 시 - 기존 주문번호 필드 표시
                        existingOrderField.style.display = "block";
                        existingOrderInput.required = true;

                        // 처리 제한 안내 표시
                        processingLimits.style.display = "block";

                        // 기존 주문번호가 입력되어 있다면 상태 확인
                        const existingOrderNumber =
                            existingOrderInput.value.trim();
                        if (existingOrderNumber) {
                            const statusCheck = await checkOrderStatusForClaim(
                                existingOrderNumber,
                                this.value
                            );
                            if (!statusCheck.canProcess) {
                                showMessage(
                                    `❌ ${statusCheck.reason}`,
                                    "error"
                                );
                                // 선택된 라디오 버튼을 그대로 유지 (되돌리지 않음)
                                return;
                            }
                        }

                        // 기존 주문번호, 상품명, 수량만 표시
                        customerNameField.style.display = "none";
                        phoneField.style.display = "none";
                        zipcodeField.style.display = "none";
                        addressField.style.display = "none";
                        detailAddressField.style.display = "none";
                        memoField.style.display = "block"; // 요청사항은 표시 (교환/반품/취소 사유)

                        // 반품/취소 시에만 환불 계좌정보 표시
                        if (this.value === "반품" || this.value === "취소") {
                            refundAccountField.style.display = "block";
                            document.getElementById(
                                "refundAccount"
                            ).required = true;
                        } else {
                            refundAccountField.style.display = "none";
                            document.getElementById(
                                "refundAccount"
                            ).required = false;
                        }

                        if (productField) productField.style.display = "block";
                        if (quantityField)
                            quantityField.style.display = "block";

                        // 필수 해제 (숨긴 필드들)
                        if (customerNameInput)
                            customerNameInput.required = false;
                        if (phoneInputEl) phoneInputEl.required = false;

                        // 라벨과 플레이스홀더 변경
                        memoLabel.textContent = "요청사항";
                        memoInput.placeholder =
                            "교환/반품/취소 사유를 입력해주세요";

                        // 필드 초기화
                        document.getElementById("customerName").value = "";
                        document.getElementById("phone").value = "";
                        document.getElementById("address").value = "";
                        document.getElementById("detailAddress").value = "";
                        document.getElementById("memo").value = "";
                        document.getElementById("refundAccount").value = "";

                        // 제출 가능
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = "📦 주문 접수하기";
                        }
                    } else {
                        // 신규주문 시
                        existingOrderField.style.display = "none";
                        existingOrderInput.required = false;
                        existingOrderInput.value = "";

                        // 처리 제한 안내 숨김
                        processingLimits.style.display = "none";

                        // 모든 필드 표시
                        customerNameField.style.display = "block";
                        phoneField.style.display = "block";
                        zipcodeField.style.display = "block";
                        addressField.style.display = "block";
                        detailAddressField.style.display = "block";
                        memoField.style.display = "block";

                        // 환불 계좌정보 필드 숨김
                        refundAccountField.style.display = "none";
                        document.getElementById(
                            "refundAccount"
                        ).required = false;

                        if (productField) productField.style.display = "block";
                        if (quantityField)
                            quantityField.style.display = "block";
                        // 필수 복원
                        if (customerNameInput)
                            customerNameInput.required = true;
                        if (phoneInputEl) phoneInputEl.required = true;
                        if (productInput) productInput.required = true;
                        if (quantityInput) quantityInput.required = true;

                        // 라벨과 플레이스홀더 변경
                        memoLabel.textContent = "배송메세지";
                        memoInput.placeholder =
                            "배송 관련 요청사항을 입력해주세요";
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = "📦 주문 접수하기";
                        }
                    }
                });
            });

            // 기존 주문번호 입력 시 자동 정보 로드 및 상태 확인 (배송조회 제외)
            document
                .getElementById("existingOrderNumber")
                .addEventListener("blur", async function () {
                    const orderNumber = this.value.trim();
                    const orderType = document.querySelector(
                        'input[name="orderType"]:checked'
                    ).value;

                    // 교환/반품/취소인 경우 주문 상태 확인
                    if (
                        orderNumber &&
                        orderType !== "신규주문" &&
                        orderType !== "배송조회"
                    ) {
                        const statusCheck = await checkOrderStatusForClaim(
                            orderNumber,
                            orderType
                        );
                        if (!statusCheck.canProcess) {
                            showMessage(`❌ ${statusCheck.reason}`, "error");
                            // 선택된 주문유형을 그대로 유지 (되돌리지 않음)
                            return;
                        }
                    }

                    if (
                        orderNumber &&
                        orderType !== "신규주문" &&
                        orderType !== "배송조회"
                    ) {
                        try {
                            const existingOrder = await findExistingOrder(
                                orderNumber,
                                ""
                            );
                            if (existingOrder) {
                                // 기존 주문 정보를 자동으로 채워줌
                                document.getElementById("customerName").value =
                                    existingOrder.customerName;
                                document.getElementById("phone").value =
                                    existingOrder.phone;
                                document.getElementById("product").value =
                                    existingOrder.product;
                                document.getElementById("quantity").value =
                                    existingOrder.quantity;
                                document.getElementById("address").value =
                                    existingOrder.address || "";
                                document.getElementById("detailAddress").value =
                                    existingOrder.detailAddress || "";

                                // 기존 주문의 배송메세지를 요청사항에 자동으로 채워줌
                                if (existingOrder.memo) {
                                    document.getElementById(
                                        "memo"
                                    ).value = `[기존주문] ${existingOrder.memo}`;
                                }

                                // 성공 메시지
                                showMessage(
                                    `✅ 기존 주문 정보를 불러왔습니다. (${existingOrder.customerName}님)`,
                                    "success"
                                );
                            } else {
                                showMessage(
                                    "❌ 해당 주문번호를 찾을 수 없습니다.",
                                    "error"
                                );
                            }
                        } catch (error) {
                            console.error("기존 주문 검색 오류:", error);
                        }
                    }
                });

            // 주소 찾기 기능 (Daum 우편번호 API)
            document
                .getElementById("btnFindAddr")
                .addEventListener("click", function () {
                    new daum.Postcode({
                        oncomplete: function (data) {
                            document.getElementById("zipcode").value =
                                data.zonecode;
                            document.getElementById("address").value =
                                data.address;
                            document.getElementById("detailAddress").focus();
                        },
                    }).open();
                });

            // 주문 확인 모달 이벤트
            document
                .getElementById("confirmOrder")
                .addEventListener("click", async function () {
                    const modal = document.getElementById("orderConfirmModal");
                    const orderData = modal.orderData;

                    try {
                        // Firebase에 주문 저장 (월별 폴더 구조)
                        const now = new Date();
                        const yearMonth = `${now.getFullYear()}-${String(
                            now.getMonth() + 1
                        ).padStart(2, "0")}`;
                        const ordersRef = ref(database, `orders/${yearMonth}`);
                        await push(ordersRef, orderData);

                        // 모달 닫기
                        modal.style.display = "none";

                        // 주문내역 저장 모달 표시
                        showSaveOrderModal(orderData);
                    } catch (error) {
                        console.error("주문 저장 오류:", error);
                        showMessage(
                            "❌ 주문 저장 중 오류가 발생했습니다.",
                            "error"
                        );
                    }
                });

            // 배송조회 처리
            document
                .getElementById("btnSubmit")
                .addEventListener("click", async function (e) {
                    const orderType = document.querySelector(
                        'input[name="orderType"]:checked'
                    ).value;

                    if (orderType === "배송조회") {
                        e.preventDefault(); // 폼 제출 방지

                        const orderNumber = document
                            .getElementById("existingOrderNumber")
                            .value.trim();
                        if (!orderNumber) {
                            showMessage("❌ 주문번호를 입력해주세요.", "error");
                            return;
                        }

                        try {
                            // 정확한 주문번호로 검색 (부분 일치가 아닌 완전 일치)
                            const existingOrder = await findExistingOrder(
                                orderNumber,
                                ""
                            );
                            if (existingOrder) {
                                // 주문번호가 정확히 일치하는지 확인
                                if (existingOrder.orderNumber !== orderNumber) {
                                    showMessage(
                                        "❌ 주문번호가 정확히 일치하지 않습니다.",
                                        "error"
                                    );
                                    return;
                                }

                                const canShow =
                                    existingOrder.status === "배송중" ||
                                    existingOrder.status === "배송완료";
                                if (
                                    canShow &&
                                    (existingOrder.invoiceNumber ||
                                        existingOrder.courier)
                                ) {
                                    showMessage(
                                        `📦 택배사: ${
                                            existingOrder.courier || "-"
                                        } / 송장번호: ${
                                            existingOrder.invoiceNumber || "-"
                                        }`,
                                        "info"
                                    );
                                } else {
                                    showMessage(
                                        "🚚 아직 배송정보가 없거나 송장 미등록 상태입니다.",
                                        "warning"
                                    );
                                }
                            } else {
                                showMessage(
                                    "❌ 해당 주문번호를 찾을 수 없습니다.",
                                    "error"
                                );
                            }
                        } catch (error) {
                            console.error("배송조회 오류:", error);
                            showMessage(
                                "❌ 배송조회 중 오류가 발생했습니다.",
                                "error"
                            );
                        }
                        return;
                    }

                    // 다른 주문 유형은 기존 로직으로 진행
                    showOrderConfirmModal();
                });

            document
                .getElementById("cancelOrder")
                .addEventListener("click", function () {
                    document.getElementById("orderConfirmModal").style.display =
                        "none";
                });

            // 주문내역 저장 모달 이벤트
            document
                .getElementById("saveToAlbum")
                .addEventListener("click", function () {
                    const modal = document.getElementById("saveOrderModal");
                    const orderData = modal.orderData;

                    try {
                        // 주문내역을 이미지로 생성
                        const imageData = generateOrderImage(orderData);

                        // PC/모바일 환경별 이미지 저장 함수
                        async function saveImageToAlbum() {
                            try {
                                // Canvas를 Blob으로 변환
                                const canvas = document.createElement("canvas");
                                const ctx = canvas.getContext("2d");
                                const img = new Image();

                                img.onload = function () {
                                    canvas.width = img.width;
                                    canvas.height = img.height;
                                    ctx.drawImage(img, 0, 0);

                                    canvas.toBlob(async function (blob) {
                                        try {
                                            // PC 환경 감지 (모바일이 아닌 경우)
                                            const isPC =
                                                !/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
                                                    navigator.userAgent
                                                );

                                            if (isPC) {
                                                // PC 환경: 바로 다운로드 폴더에 저장
                                                const link =
                                                    document.createElement("a");
                                                link.download = `주문내역_${orderData.orderNumber}.png`;
                                                link.href = imageData;
                                                link.click();
                                                showMessage(
                                                    "✅ 이미지가 다운로드 폴더에 저장되었습니다.",
                                                    "success"
                                                );
                                                return;
                                            }

                                            // 모바일 환경: 기존 방식 유지
                                            // 모바일에서 공유 API 사용 (iOS/Android)
                                            if (
                                                navigator.share &&
                                                navigator.canShare
                                            ) {
                                                const file = new File(
                                                    [blob],
                                                    `주문내역_${orderData.orderNumber}.png`,
                                                    { type: "image/png" }
                                                );

                                                if (
                                                    navigator.canShare({
                                                        files: [file],
                                                    })
                                                ) {
                                                    await navigator.share({
                                                        files: [file],
                                                        title: "주문내역",
                                                        text: "주문내역 이미지",
                                                    });
                                                    showMessage(
                                                        "✅ 이미지를 공유했습니다. 앨범에 저장하거나 다른 앱으로 전송할 수 있습니다.",
                                                        "success"
                                                    );
                                                    return;
                                                }
                                            }

                                            // 공유 API가 지원되지 않는 경우 대체 방법
                                            if (
                                                /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
                                                    navigator.userAgent
                                                )
                                            ) {
                                                // 모바일 환경 - 새 창에서 이미지 열기
                                                const url =
                                                    URL.createObjectURL(blob);
                                                const newWindow =
                                                    window.open(url);
                                                if (newWindow) {
                                                    showMessage(
                                                        "✅ 이미지가 새 창에서 열렸습니다. 길게 눌러서 '이미지 저장'을 선택하세요.",
                                                        "success"
                                                    );
                                                } else {
                                                    // 팝업 차단된 경우 다운로드
                                                    const link =
                                                        document.createElement(
                                                            "a"
                                                        );
                                                    link.href = url;
                                                    link.download = `주문내역_${orderData.orderNumber}.png`;
                                                    link.click();
                                                    showMessage(
                                                        "✅ 이미지가 다운로드되었습니다. 다운로드 폴더에서 확인하세요.",
                                                        "success"
                                                    );
                                                }
                                                setTimeout(
                                                    () =>
                                                        URL.revokeObjectURL(
                                                            url
                                                        ),
                                                    1000
                                                );
                                            }
                                        } catch (shareError) {
                                            console.error(
                                                "공유 오류:",
                                                shareError
                                            );
                                            // 공유 실패 시 일반 다운로드
                                            const link =
                                                document.createElement("a");
                                            link.download = `주문내역_${orderData.orderNumber}.png`;
                                            link.href = imageData;
                                            link.click();
                                            showMessage(
                                                "✅ 이미지가 다운로드되었습니다.",
                                                "success"
                                            );
                                        }
                                    }, "image/png");
                                };

                                img.src = imageData;
                            } catch (error) {
                                console.error("앨범 저장 오류:", error);
                                // 대체 방법: 일반 다운로드
                                const link = document.createElement("a");
                                link.download = `주문내역_${orderData.orderNumber}.png`;
                                link.href = imageData;
                                link.click();
                                showMessage(
                                    "✅ 이미지가 다운로드되었습니다.",
                                    "success"
                                );
                            }
                        }

                        // 이미지 저장 실행
                        saveImageToAlbum();

                        // 모달 닫기
                        modal.style.display = "none";

                        // 폼 초기화
                        orderForm.reset();
                        showMessage(
                            "✅ 주문이 성공적으로 접수되었습니다!",
                            "success"
                        );
                    } catch (error) {
                        console.error("이미지 생성 오류:", error);
                        showMessage(
                            "❌ 이미지 생성 중 오류가 발생했습니다.",
                            "error"
                        );
                    }
                });

            document
                .getElementById("skipSave")
                .addEventListener("click", function () {
                    const modal = document.getElementById("saveOrderModal");
                    modal.style.display = "none";

                    // 폼 초기화 및 성공 메시지
                    orderForm.reset();
                    showMessage(
                        "✅ 주문이 성공적으로 접수되었습니다!",
                        "success"
                    );
                });

            // 관리자 페이지 열기 (PIN 대신 로그인 모달 표시)
            btnAdmin.addEventListener("click", function () {
                window.isAdminLoginFlow = true;
                document.getElementById("loginModal").style.display = "flex";
            });

            // 페이지 로드 시 주소 API 로드
            window.addEventListener("load", function () {
                if (typeof daum === "undefined") {
                    const script = document.createElement("script");
                    script.src =
                        "//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js";
                    document.head.appendChild(script);
                }
            });

            // Enter 키로 로그인
            document
                .getElementById("loginPassword")
                .addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        login();
                    }
                });

            // 로그인 모달 닫기 함수
            window.closeLoginModal = function () {
                document.getElementById("loginModal").style.display = "none";
                document.getElementById("loginEmail").value = "";
                document.getElementById("loginPassword").value = "";
                document.getElementById("loginError").textContent = "";
            };
        </script>
    </body>
</html>
